<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Graduation Memories - Optimized Fall</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Pretendard:wght@700&display=swap');

        body {
            margin: 0 auto; padding: 0;
            width: 860px; height: 1034px;
            overflow: hidden;
            background: url('images/background_p.png') no-repeat center center;
            background-size: cover;
            font-family: 'Pretendard', sans-serif;
            position: relative;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 253, 245, 0.4); 
            z-index: 0;
        }

        #photo-container {
            position: relative;
            width: 860px; height: 1034px;
            z-index: 1;
        }

        .header-title {
            position: absolute;
            top: 40px; width: 100%;
            text-align: center;
            font-family: 'Black Han Sans', sans-serif;
            font-size: 50px;
            color: #2c3e50;
            z-index: 1000;
            text-shadow: 2px 2px 10px rgba(255,255,255,0.9);
            pointer-events: none;
        }

        .stacked-photo {
            position: absolute;
            width: 300px;
            padding: 10px 10px 40px 10px; 
            background: white;
            box-shadow: 5px 12px 25px rgba(0,0,0,0.2);
            border-radius: 2px;
            opacity: 0;
            /* transform 지연 최소화를 위해 초기값 설정 */
            transform: scale(1.1) translateY(-20px);
            transition: opacity 0.4s ease-out, transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            will-change: transform, opacity; /* 브라우저 최적화 힌트 */
        }

        .stacked-photo img {
            max-width: 100%;
            max-height: 380px;
            width: auto; height: auto;
            object-fit: contain;
            display: block;
        }

        .stacked-photo.active {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        .stacked-photo.falling {
            opacity: 0;
            pointer-events: none;
            transition: transform 1s cubic-bezier(0.5, 0, 1, 0.5), opacity 0.8s ease-in;
        }
    </style>
</head>
<body>

    <h1 class="header-title">우리들의 소중한 기억</h1>
    <div id="photo-container"></div>

<script>
    const TOTAL_PHOTOS = 124; 
    const IMAGE_EXTENSION = 'jpg'; 
    const SHOW_INTERVAL = 1000; // 1초 간격 고정
    const WAIT_BEFORE_CLEAR = 5000; 

    const container = document.getElementById('photo-container');
    let currentIndex = 1;
    let timer = null;

    function startSlideshow() {
        // 일정한 주기로 실행되는 인터벌 방식 사용
        timer = setInterval(() => {
            if (currentIndex > TOTAL_PHOTOS) {
                clearInterval(timer); // 사진 다 뜨면 타이머 중지
                setTimeout(clearPhotos, WAIT_BEFORE_CLEAR);
                return;
            }
            renderPhoto(currentIndex);
            currentIndex++;
        }, SHOW_INTERVAL);
    }

    function renderPhoto(num) {
        const imgFrame = document.createElement('div');
        imgFrame.className = 'stacked-photo';
        
        const img = new Image();
        img.src = `photos/${num}.${IMAGE_EXTENSION}`;
        
        img.onload = function() {
            imgFrame.appendChild(img);
            container.appendChild(imgFrame);

            const randomX = Math.floor(Math.random() * (860 - 250)) - 30; 
            const randomY = Math.floor(Math.random() * (1034 - 300)) - 20;
            const randomRotate = Math.floor(Math.random() * 60) - 30;

            let finalX = randomX;
            let finalY = randomY;
            if (finalY < 150 && (finalX > 200 && finalX < 450)) {
                finalY += 220;
            }

            imgFrame.style.left = `${finalX}px`;
            imgFrame.style.top = `${finalY}px`;
            imgFrame.dataset.rotate = randomRotate;

            // 브라우저 렌더링 타이밍 강제 동기화 (requestAnimationFrame)
            requestAnimationFrame(() => {
                setTimeout(() => {
                    imgFrame.style.transform = `rotate(${randomRotate}deg) scale(1)`;
                    imgFrame.classList.add('active');
                }, 10);
            });
        };
    }

    function clearPhotos() {
        const photos = Array.from(document.querySelectorAll('.stacked-photo'));
        const shuffledPhotos = photos.sort(() => Math.random() - 0.5);

        shuffledPhotos.forEach((photo, index) => {
            const delay = Math.random() * 1000; 
            setTimeout(() => {
                const currentRotate = parseFloat(photo.dataset.rotate);
                const extraRotate = (Math.random() > 0.5 ? 180 : -180);
                photo.style.transform = `translateY(1200px) rotate(${currentRotate + extraRotate}deg)`;
                photo.classList.add('falling');
            }, delay);
        });

        setTimeout(() => {
            container.innerHTML = '';
            currentIndex = 1;
            startSlideshow(); // 다시 시작
        }, 3000); 
    }

    // 초기 실행
    startSlideshow();
</script>

</body>
</html>
