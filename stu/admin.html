<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì í”¼ë“œ ë·°ì–´</title>
  <style>
    body {
      font-family: Pretendard, "Noto Sans KR", sans-serif;
      margin: 0; padding: 0;
      background: #f9fafb;
      color: #333;
    }
    header {
      background: #4f46e5;
      color: #fff;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    select {
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    main {
      padding: 1rem;
    }
    #currentView {
      margin-bottom: 1rem;
      font-weight: bold;
      font-size: 1rem;
    }
    .feed {
      border: 1px solid #ddd;
      background: #fff;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .feed h3 {
      margin: 0 0 6px 0;
      color: #1d4ed8;
    }
    .feed p {
      margin: 0 0 8px 0;
      white-space: pre-line;
      font-size: 0.9rem;
    }
    .feed small {
      color: #666;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“Œ ê´€ë¦¬ì í”¼ë“œ ë·°ì–´</h1>
    <select id="classSelect">
      <option value="all">ì „ì²´ í”¼ë“œ</option>
      <script>
        for (let g = 1; g <= 3; g++) {
          for (let c = 1; c <= 12; c++) {
            document.write(`<option value="${g}-${c}">${g}í•™ë…„ ${c}ë°˜</option>`);
          }
        }
      </script>
    </select>
  </header>

  <main>
    <div id="currentView">ì „ì²´ í”¼ë“œ</div>
    <div id="feedList"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ===== Firebase ì„¤ì • =====
    const firebaseConfig = {
      apiKey: "AIzaSyA_ufzFnMFovKW0JhNyrXWYV2a_1cCt5Vs",
      authDomain: "sungilnow.firebaseapp.com",
      projectId: "sungilnow",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const feedList = document.getElementById("feedList");
    const classSelect = document.getElementById("classSelect");
    const titleBar = document.getElementById("currentView");

    // ===== ë‚ ì§œ í‚¤ =====
    function getCurrentMonthKey() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
    }

    // ===== í”¼ë“œ ë¶ˆëŸ¬ì˜¤ê¸° =====
    async function loadFeeds(path, label) {
      feedList.innerHTML = "<p>â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
      titleBar.textContent = label;

      try {
        const q = query(collection(db, path), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);

        if (snap.empty) {
          feedList.innerHTML = "<p>ğŸ“­ í”¼ë“œ ì—†ìŒ</p>";
          return;
        }

        feedList.innerHTML = "";
        snap.forEach(doc => {
          const data = doc.data();
          const createdAt = data.createdAt?.seconds
            ? new Date(data.createdAt.seconds * 1000).toLocaleString()
            : "ì‹œê°„ ì—†ìŒ";

          const item = document.createElement("div");
          item.className = "feed";
          item.innerHTML = `
            <h3>${data.title}</h3>
            <p>${data.content}</p>
            <small>${data.author || "ì‘ì„±ì ì—†ìŒ"} Â· ${createdAt}</small>
          `;
          feedList.appendChild(item);
        });
      } catch (err) {
        console.error("í”¼ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
        feedList.innerHTML = "<p>âŒ ê¶Œí•œì´ ì—†ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>";
      }
    }

    // ===== ê´€ë¦¬ì í˜ì´ì§€ ì‹œì‘ =====
    function startAdminFeedViewer(user) {
      if (!user.email.endsWith("@sungil-i.kr")) {
        alert("í•™êµ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      const monthKey = getCurrentMonthKey();
      loadFeeds(`feeds/${monthKey}/items`, "ì „ì²´ í”¼ë“œ");

      classSelect.addEventListener("change", () => {
        const value = classSelect.value;
        if (value === "all") {
          loadFeeds(`feeds/${monthKey}/items`, "ì „ì²´ í”¼ë“œ");
        } else {
          loadFeeds(`classFeeds/${value}/feeds_${monthKey}`, `${value} í”¼ë“œ`);
        }
      });
    }

    // ===== ì¸ì¦ ìƒíƒœ í™•ì¸ =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        try {
          const result = await signInWithPopup(auth, provider);
          console.log("ê´€ë¦¬ì ë¡œê·¸ì¸:", result.user.email);
          startAdminFeedViewer(result.user);
        } catch (err) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          console.error(err);
        }
      } else {
        console.log("ì´ë¯¸ ë¡œê·¸ì¸:", user.email);
        startAdminFeedViewer(user);
      }
    });
  </script>
</body>
</html>