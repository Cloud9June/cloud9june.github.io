<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>학생 급식 인원 확인</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
    /* Layout & typography */
    body { max-width: 880px; margin: 40px auto; font-family: Arial, sans-serif; }
    h2 { margin-top: 36px; }
    #monthTitle { font-weight: bold; margin: 6px 0 10px; }
    .hint { font-size: 13px; color:#666; margin-top: 6px; }

    /* Form (상단 툴바) */
    .form { display: flex; gap: 12px; align-items: center; margin-bottom: 18px; flex-wrap: wrap; }
    .form label { display: flex; align-items: center; gap: 6px; }
    input[type="number"], select { padding: 6px 8px; }
    #saveBtn { background: #ffebee; border: 1px solid #1976d2; color: blue; padding: 5px; cursor: pointer; border-radius: 6px; }
    #resetBtn { background:#ffebee; border:1px solid #e57373; color:#c62828; padding: 5px; cursor: pointer; border-radius: 6px; }

    /* Legend */
    #legend { display: flex; gap: 14px; font-size: 14px; margin: 10px 0 4px; color:#555; }
    #legend span { display: inline-flex; align-items: center; gap:6px; }
    #legend i { width: 14px; height: 14px; display:inline-block; border:1px solid #ddd; border-radius:3px; }
    #legend i.schoolday { background:#e3f2fd; border-color:#cfe3fa; }
    #legend i.weekend { background:#f8f8f8; border-color:#eee; }
    #legend i.disabled { background:#eee; }

    /* Calendar */
    #calendar { display: flex; flex-direction: column; gap: 6px; }
    .weekdays, .calendar-row { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 6px; }
    .weekday { font-weight: 600; color:#444; }
    .calendar-cell {
      min-height: 84px; padding: 8px; border: 1px solid #ddd; background:#fff; border-radius: 10px;
      display: flex; flex-direction: column; justify-content: space-between; align-items: center;
      transition: box-shadow .2s ease, transform .05s ease;
    }
    .calendar-cell .date { font-weight: 700; }
    .calendar-cell.schoolday { background: #e3f2fd; border-color:#cfe3fa; }
    .calendar-cell.schoolday:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
    .calendar-cell.disabled { background:#eee; color:#999; font-weight: 600; }
    .calendar-cell.empty { background:#f7f7f7; border-style: dashed; }
    .calendar-cell.weekend { background:#f8f8f8; color:#d32f2f; }
    .calendar-cell.weekend.disabled { background:#e0e0e0; color:#a66; }

    /* Count UI: 숫자 1줄 + 버튼 1줄(세로 배치) */
    .count-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }
    .count { 
      font-size: 14px; 
      color:#1976d2; 
      min-width: auto;
      text-align: center; 
      cursor: pointer; 
    }
    .controls {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .pm-btn {
      width: 24px; height: 24px;
      border: 1px solid #cfe3fa; background:#e3f2fd;
      border-radius: 50%;
      font-weight: 700; line-height: 22px;
      cursor: pointer; user-select: none;
    }
    .edit-icon { font-size: 12px; color:#888; cursor: pointer; user-select: none; }

    /* Section 3: 결석 표 */
    #absenceTable { width:100%; border-collapse: collapse; margin-bottom:10px; }
    #absenceTable th, #absenceTable td { border-bottom:1px solid #ddd; padding:8px; }
    #absenceTable thead th { text-align:left; background:#fafafa; }
    .absense-actions { display:flex; gap:8px; margin-bottom:18px; }
    .absense-actions button { padding:6px 10px; border-radius:6px; cursor:pointer; border:1px solid #cfd8dc; background:#fff; }
    #saveAbsenceBtn { background:#e8f5e9; border:1px solid #81c784; color:#2e7d32; }

  </style>
</head>
<body>
  <h2>1. 학생 인원 등록 및 월 일괄 저장</h2>
  <div class="form">
    <label>연도: <select id="yearSelect"></select></label>
    <label>월: <select id="monthSelect"></select></label>
    <label>인원수: <input type="number" id="studentCount" placeholder="예: 320" min="0" /></label>
    <button id="saveBtn">저장(등교일 전체 채우기)</button>
    <button id="resetBtn">초기화</button>
  </div>

  <h2>2. 학생 급식 인원 확인/수정</h2>
  <div id="monthTitle"></div>
  <div id="legend">
    <span><i class="schoolday"></i>등교일(수정 가능)</span>
    <span><i class="weekend"></i>주말</span>
    <span><i class="disabled"></i>급식미실시</span>
  </div>
  <div id="calendar"></div>
  <div class="hint">Tip: 숫자를 클릭하면 직접 입력, 아래 - ✎ + 버튼으로 1명씩 조정할 수 있어요.</div>

  <h2>3. 취업 및 현장체험 학습으로 인한 급식 미실시 학생</h2>
  <table id="absenceTable">
    <thead>
      <tr>
        <th>상황</th>
        <th style="width:100px;">인원</th>
        <th style="width:180px;">시작일</th>
        <th style="width:180px;">종료일</th>
        <th style="width:80px;">삭제</th>
      </tr>
    </thead>
    <tbody id="absenceBody"></tbody>
  </table>
  <div class="absense-actions">
    <button id="addAbsenceBtn">행 추가</button>
    <button id="saveAbsenceBtn">표 저장</button>
    <span class="hint">예) 상황: 현장체험학습, 인원: 3, 기간: 2025-08-18 ~ 2025-08-19</span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyBRAOzrMccWaw-l5Z6YtHgpW9Gr80UTRhw",
      authDomain: "mealmanager-cda3b.firebaseapp.com",
      projectId: "mealmanager-cda3b"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db  = getFirestore(app);

    // DOM
    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");
    const studentCountInput = document.getElementById("studentCount");
    const saveBtn = document.getElementById("saveBtn");
    const resetBtn = document.getElementById("resetBtn");
    const calendar = document.getElementById("calendar");
    const monthTitle = document.getElementById("monthTitle");
    const addAbsenceBtn  = document.getElementById("addAbsenceBtn");
    const saveAbsenceBtn = document.getElementById("saveAbsenceBtn");

    // 기본 날짜/옵션
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    for (let y = currentYear - 1; y <= currentYear + 1; y++) {
      const opt = new Option(`${y}년`, y);
      if (y === currentYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }
    for (let m = 1; m <= 12; m++) {
      const opt = new Option(`${m}월`, m);
      if (m === currentMonth) opt.selected = true;
      monthSelect.appendChild(opt);
    }

    // 유틸/참조
    const pad2 = (n) => String(n).padStart(2, "0");
    const monthId = (y,m) => `${y}-${pad2(m)}`;
    const studentsDailyRef           = (y,m) => doc(db, "studentsDaily", monthId(y,m));            // 기본
    const studentsDailyEffectiveRef  = (y,m) => doc(db, "studentsDailyEffective", monthId(y,m));   // 차감 반영본
    const blockedDaysRef             = (y,m) => doc(db, "blockedDays" , monthId(y,m));
    const studentAbsencesRef         = (y,m) => doc(db, "studentAbsences", monthId(y,m));

    function toSafeInt(v, def = 0) {
      const n = Number(v);
      if (!Number.isFinite(n) || Number.isNaN(n)) return def;
      const i = Math.floor(n);
      return i < 0 ? 0 : i;
    }

    // ---- 읽기 helpers
    async function fetchBlockedDays(year, month) {
      const snap = await getDoc(blockedDaysRef(year, month));
      if (snap.exists() && Array.isArray(snap.data().days)) return snap.data().days.map(Number);
      return [];
    }
    async function fetchMonthDays(year, month) {
      const snap = await getDoc(studentsDailyRef(year, month));
      if (snap.exists() && snap.data().days && typeof snap.data().days === "object") {
        const raw = snap.data().days, norm = {};
        for (const k of Object.keys(raw)) norm[k] = toSafeInt(raw[k]);
        return norm;
      }
      return {};
    }
    async function fetchAbsenceItems(year, month) {
      const snap = await getDoc(studentAbsencesRef(year, month));
      return (snap.exists() && Array.isArray(snap.data().items)) ? snap.data().items : [];
    }

    // ---- 저장 helpers
    async function saveMonthAllSchoolDays(year, month, value) {
      const val = toSafeInt(value);
      const startDate = new Date(year, month - 1, 1);
      const endDate   = new Date(year, month, 0);
      const firstDayIndex = startDate.getDay();
      const lastDate  = endDate.getDate();
      const blocked   = await fetchBlockedDays(year, month);
      const daysMap = {};
      for (let d=1; d<=lastDate; d++) {
        const dow = (firstDayIndex + d - 1) % 7;
        const isWeekend = (dow===0 || dow===6);
        if (!isWeekend && !blocked.includes(d)) daysMap[String(d)] = val;
      }
      await setDoc(studentsDailyRef(year, month), { days: daysMap }, { merge: true });
    }
    async function updateSingleDay(year, month, day, value) {
      const n = toSafeInt(value);
      await setDoc(studentsDailyRef(year, month), { days: { [String(day)]: n } }, { merge: true });
    }

    // ---- 결석 표
    function makeAbsenceRow(item = { situation:"", count:1, start:"", end:"" }) {
      const tr = document.createElement("tr");
      const tdS = document.createElement("td");
      const tdC = document.createElement("td");
      const tdSt= document.createElement("td");
      const tdEn= document.createElement("td");
      const tdRm= document.createElement("td");

      const inS = Object.assign(document.createElement("input"), { type:"text", placeholder:"상황(예: 현장체험학습)", value:item.situation||"" });
      inS.style.width="100%";
      const inC = Object.assign(document.createElement("input"), { type:"number", min:"0", value:toSafeInt(item.count??1) });
      inC.style.width="80px";
      const inSt= Object.assign(document.createElement("input"), { type:"date", value:item.start||"" });
      const inEn= Object.assign(document.createElement("input"), { type:"date", value:item.end||"" });

      const btnRm = document.createElement("button");
      btnRm.textContent = "삭제";
      btnRm.style.padding = "4px 8px";
      btnRm.onclick = () => tr.remove();

      tdS.appendChild(inS); tdC.appendChild(inC);
      tdSt.appendChild(inSt); tdEn.appendChild(inEn);
      tdRm.appendChild(btnRm);
      tr.append(tdS, tdC, tdSt, tdEn, tdRm);
      return tr;
    }
    async function loadAbsencesToTable(year, month) {
      const body = document.getElementById("absenceBody");
      body.innerHTML = "";
      const items = await fetchAbsenceItems(year, month);
      if (items.length === 0) body.appendChild(makeAbsenceRow());
      else items.forEach(it => body.appendChild(makeAbsenceRow(it)));
    }
    async function saveAbsenceTable(year, month) {
      const rows = Array.from(document.querySelectorAll("#absenceBody tr"));
      const items = [];
      for (const tr of rows) {
        const [inS, inC, inSt, inEn] = tr.querySelectorAll("input");
        const situation = (inS.value || "").trim();
        const count = toSafeInt(inC.value);
        const start = inSt.value;
        const end   = inEn.value;
        if (!situation && !count && !start && !end) continue;
        if (!start || !end) { alert("기간의 시작일과 종료일을 입력하세요."); return false; }
        if (new Date(start) > new Date(end)) { alert("기간이 올바르지 않습니다(시작일 ≤ 종료일)."); return false; }
        items.push({ situation, count, start, end });
      }
      await setDoc(studentAbsencesRef(year, month), { items, updatedAt: serverTimestamp() }, { merge: true });
      return true;
    }

    // ---- 차감 계산
    function toDayOfMonth(dateStr, year, month) {
      if (!dateStr) return null;
      const d = new Date(dateStr);
      if (isNaN(d)) return null;
      if (d.getFullYear() !== year || (d.getMonth()+1) !== month) return null;
      return d.getDate();
    }
    function buildAbsenceDeductMap(items, year, month, blocked, firstDayIndex, lastDate) {
      const deduct = {}, blockedSet = new Set(blocked);
      for (const it of items) {
        const sDay = toDayOfMonth(it.start, year, month);
        const eDay = toDayOfMonth(it.end,   year, month);
        const cnt  = toSafeInt(it.count);
        if (!sDay || !eDay || cnt<=0) continue;
        for (let d=sDay; d<=eDay; d++) {
          const dow = (firstDayIndex + d - 1) % 7;
          const isWeekend = (dow===0 || dow===6);
          if (isWeekend || blockedSet.has(d)) continue;
          const key = String(d);
          deduct[key] = (deduct[key]||0) + cnt;
        }
      }
      return deduct;
    }

    async function computeEffectiveStudentsDays(year, month) {
      const [baseDays, blocked, items] = await Promise.all([
        fetchMonthDays(year, month),
        fetchBlockedDays(year, month),
        fetchAbsenceItems(year, month),
      ]);
      const startDate = new Date(year, month - 1, 1);
      const endDate   = new Date(year, month, 0);
      const firstDayIndex = startDate.getDay();
      const lastDate  = endDate.getDate();

      const deduct = buildAbsenceDeductMap(items, year, month, blocked, firstDayIndex, lastDate);
      const effective = {};
      for (let d=1; d<=lastDate; d++) {
        const dow = (firstDayIndex + d - 1) % 7;
        const isWeekend = (dow===0 || dow===6);
        if (isWeekend || blocked.includes(d)) continue;
        const key = String(d);
        const base = toSafeInt(baseDays[key] ?? 0);
        const minus= toSafeInt(deduct[key] ?? 0);
        effective[key] = Math.max(0, base - minus);
      }
      return effective;
    }
    async function saveEffectiveStudentsDays(year, month) {
      const effective = await computeEffectiveStudentsDays(year, month);
      await setDoc(
        studentsDailyEffectiveRef(year, month),
        { days: effective, updatedAt: serverTimestamp() },
        { merge: true }
      );
    }
    let effTimer = null;
    function scheduleSaveEffective(year, month, delay=400) {
      clearTimeout(effTimer);
      effTimer = setTimeout(() => { saveEffectiveStudentsDays(year, month); }, delay);
    }

    // ---- Count UI
    function makeCountArea(year, month, day, shownVal, minusVal, onChanged) {
      const wrap = document.createElement("div"); wrap.className = "count-wrap";
      const num  = document.createElement("div"); num.className  = "count";
      num.textContent = (toSafeInt(shownVal) ?? 0) + "명"; num.title="클릭하여 직접 입력";

      const controls = document.createElement("div"); controls.className="controls";
      const btnMinus = document.createElement("button"); btnMinus.className="pm-btn"; btnMinus.textContent="−";
      const btnEdit  = document.createElement("span");   btnEdit.className="edit-icon"; btnEdit.textContent="✎";
      const btnPlus  = document.createElement("button"); btnPlus.className="pm-btn"; btnPlus.textContent="+";

      const applyChange = async (nextShown) => {
        const safeShown  = toSafeInt(nextShown);
        const baseToSave = toSafeInt(safeShown + toSafeInt(minusVal));
        num.textContent  = `${safeShown}명`;
        await updateSingleDay(year, month, day, baseToSave);
        onChanged(baseToSave);
        scheduleSaveEffective(year, month);
      };

      btnMinus.onclick = async (e)=>{ e.stopPropagation(); const curr = toSafeInt((num.textContent||"0").replace("명","")); await applyChange(Math.max(0, curr-1)); };
      btnPlus .onclick = async (e)=>{ e.stopPropagation(); const curr = toSafeInt((num.textContent||"0").replace("명","")); await applyChange(curr+1); };
      const openPrompt = async (e)=>{
        e.stopPropagation();
        const curr = toSafeInt((num.textContent||"0").replace("명",""));
        const input = prompt(`${year}년 ${month}월 ${day}일 인원수`, curr);
        if (input===null) return;
        await applyChange(toSafeInt(input));
      };
      num.onclick = openPrompt; btnEdit.onclick = openPrompt;

      controls.append(btnMinus, btnEdit, btnPlus);
      wrap.append(num, controls);
      return wrap;
    }

    // ---- 렌더
    async function renderCalendar() {
      const year  = parseInt(yearSelect.value, 10);
      const month = parseInt(monthSelect.value, 10);
      calendar.innerHTML = "";

      const startDate = new Date(year, month - 1, 1);
      const endDate   = new Date(year, month, 0);
      const firstDayIndex = startDate.getDay();
      const lastDate  = endDate.getDate();

      const [blocked, monthDays, absSnap] = await Promise.all([
        fetchBlockedDays(year, month),
        fetchMonthDays(year, month),
        getDoc(studentAbsencesRef(year, month)),
      ]);
      const absenceItems = (absSnap.exists() && Array.isArray(absSnap.data().items)) ? absSnap.data().items : [];
      const deductMap = buildAbsenceDeductMap(absenceItems, year, month, blocked, firstDayIndex, lastDate);

      await loadAbsencesToTable(year, month);
      monthTitle.textContent = `${year}년 ${month}월`;

      const daysOfWeek = ["일","월","화","수","목","금","토"];
      const header = document.createElement("div"); header.className="weekdays";
      daysOfWeek.forEach(d=>{ const c=document.createElement("div"); c.className="weekday"; c.textContent=d; header.appendChild(c); });
      calendar.appendChild(header);

      let dateNum = 1;
      for (let i=0;i<6;i++){
        const row = document.createElement("div"); row.className="calendar-row";
        for (let j=0;j<7;j++){
          const cell = document.createElement("div"); cell.className="calendar-cell";
          if (i===0 && j<firstDayIndex) {
            cell.classList.add("empty");
          } else if (dateNum<=lastDate) {
            const dow = (firstDayIndex + dateNum - 1) % 7;
            const isWeekend = (dow===0 || dow===6);
            const isBlocked = blocked.includes(dateNum);
            const dayKey = String(dateNum);
            const base  = toSafeInt(monthDays[dayKey] ?? 0);
            const minus = toSafeInt(deductMap[dayKey] ?? 0);
            const shown = Math.max(0, base - minus);

            const dateEl = document.createElement("div"); dateEl.className="date"; dateEl.textContent=dateNum;
            cell.appendChild(dateEl);

            if (isWeekend) cell.classList.add("weekend");
            if (isWeekend || isBlocked) {
              cell.classList.add("disabled");
              const info = document.createElement("div");
              info.style.fontSize="13px"; info.style.color="#888";
              info.textContent = isWeekend ? "" : "급식미실시";
              cell.appendChild(info);
            } else {
              cell.classList.add("schoolday");
              const countWrap = makeCountArea(
                year, month, dateNum, shown, minus,
                (nextBase)=>{ monthDays[dayKey]=toSafeInt(nextBase); }
              );
              cell.appendChild(countWrap);
              if (minus>0) {
                const badge=document.createElement("div");
                badge.textContent=`-${minus}`; badge.style.fontSize="11px"; badge.style.color="#b71c1c";
                cell.appendChild(badge);
              }
            }
            dateNum++;
          } else {
            cell.classList.add("empty");
          }
          row.appendChild(cell);
        }
        calendar.appendChild(row);
        if (dateNum>lastDate) break;
      }
    }

    // ---- 이벤트(버튼/셀렉트)
    function wireEvents() {
      saveBtn.onclick = async ()=>{
        const y = parseInt(yearSelect.value,10), m = parseInt(monthSelect.value,10);
        const count = toSafeInt(studentCountInput.value);
        await saveMonthAllSchoolDays(y, m, count);
        await saveEffectiveStudentsDays(y, m);
        alert("저장되었습니다. (등교일 전체 채움)");
        await renderCalendar();
      };
      resetBtn.onclick = async ()=>{
        if (!confirm("정말로 이 달의 모든 등교일 인원을 0명으로 초기화하시겠습니까?")) return;
        const y = parseInt(yearSelect.value,10), m = parseInt(monthSelect.value,10);
        await saveMonthAllSchoolDays(y, m, 0);
        await saveEffectiveStudentsDays(y, m);
        alert("초기화 완료되었습니다. (등교일 전체 0명)");
        await renderCalendar();
      };
      addAbsenceBtn.onclick = ()=>{
        document.getElementById("absenceBody").appendChild(makeAbsenceRow());
      };
      saveAbsenceBtn.onclick = async ()=>{
        const y = parseInt(yearSelect.value,10), m = parseInt(monthSelect.value,10);
        const ok = await saveAbsenceTable(y, m);
        if (ok) {
          await saveEffectiveStudentsDays(y, m);
          alert("표가 저장되었습니다. (달력 및 집계에 자동 반영)");
          await renderCalendar();
        }
      };
      yearSelect.onchange = renderCalendar;
      monthSelect.onchange = renderCalendar;
    }

    // ---- 게이트: 로그인 → 도메인(@sungil-i.kr) → roles(admin) 후 시작
    onAuthStateChanged(auth, async (user) => {
      if (!user) { alert("로그인이 필요합니다."); location.href = "index.html"; return; }
      const email = user.email || "";
      if (!/@sungil-i\.kr$/i.test(email)) {
        alert("교내 계정(@sungil-i.kr)으로만 접근 가능합니다.");
        await signOut(auth); location.href = "index.html"; return;
      }

      try {
        const role = await getDoc(doc(db, "roles", email));
        const isAdmin = role.exists() && role.data().role === "admin";
        if (!isAdmin) { alert("관리자 전용 페이지입니다."); location.href = "meal.html"; return; }
      } catch (e) {
        console.error("roles 확인 실패:", e);
        alert("권한 확인에 실패했습니다."); return;
      }

      // ✅ 권한 확인 후에만 Firestore 접근 시작
      await renderCalendar();
      wireEvents();

      // 페이지 진입 시에도 학생 차감 반영본을 한 번 보정 생성(선택)
      const y = parseInt(yearSelect.value,10), m = parseInt(monthSelect.value,10);
      scheduleSaveEffective(y, m, 100);
    });
  </script>

</body>
</html>
