<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê¸‰ì‹ ì‹ ì²­ ì„¤ì •</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    body { width:100%; max-width: 900px; margin: 50px auto 80px; font-family:'Pretendard',sans-serif; }
    h2 + p { color:#444; text-decoration: underline; }
    .select-wrapper { display:flex; gap:10px; margin-bottom:20px; align-items:center; flex-wrap:wrap; }
    .month-grid { display:grid; grid-template-columns: repeat(6, 1fr); gap:10px; margin-top:20px; }
    .month-grid button { padding:10px; border-radius:8px; font-size:1em; background:#eee; cursor:pointer; border:1px solid #e3e3e3; }
    .month-grid button.active { background:#1976d2; color:#fff; }
    .calendar { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; max-width:900px; margin:20px auto; contain:content; }
    .calendar div { padding:10px 6px; height:68px; background:#fff; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.06); border:1px solid #ddd; }
    .calendar .weekday { font-weight:700; background:#f3f4f6; color:#374151; height:36px; text-align:center; display:flex; align-items:center; justify-content:center; }
    .calendar .weekday:nth-child(1){ color:#e24666; } .calendar .weekday:nth-child(7){ color:#0b7bff; }
    .calendar .disabled { opacity:.6; background: #999;}
    .note-input { display:block; width:80%; margin-top:6px; padding:6px 8px; border:none; border-radius:6px; font-size:.9em; background:#999; color: red; font-weight: bold;}
    .skel { background:#eee; border:1px solid #e5e7eb; animation:pulse 1.1s infinite; }
    @keyframes pulse { 0%{opacity:.55} 50%{opacity:.95} 100%{opacity:.55} }
    .muted { color:#6b7280; font-size:.9em; }
  </style>
</head>
<body>
  <h2>1. ê¸‰ì‹ ì‹ ì²­ ê°€ëŠ¥ ì›” ì„¤ì •</h2>
  <p>ê¸‰ì‹ ì‹ ì²­ ê°€ëŠ¥í•œ ì—°ë„ì™€ ì›”ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

  <div class="select-wrapper">
    <label for="yearSelect">ì—°ë„ ì„ íƒ:</label>
    <select id="yearSelect"></select>

    <label for="teacherYearSelect" style="margin-left: 20px;">êµì‚¬ ì‹ ì²­ ì—°ë„:</label>
    <select id="teacherYearSelect">
      <option value="2025">2025ë…„</option>
      <option value="2026">2026ë…„</option>
    </select>
    <button id="saveTeacherYear">ì €ì¥</button>
    <span id="syncHint" class="muted" style="margin-left:8px; display:none">ë™ê¸°í™” ì¤‘â€¦</span>
  </div>

  <div class="month-grid" id="monthGrid"></div>

  <h2 style="margin-top:40px;">2. ê¸‰ì‹ ì‹ ì²­ ë¶ˆê°€ ì¼ ì„¤ì •</h2>
  <p>ì„ íƒí•œ ë‚ ì€ ê¸‰ì‹ì„ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>

  <div class="select-wrapper">
    <button id="prevMonth">ì§€ë‚œ ë‹¬</button>
    <label for="blockYear">ì—°ë„:</label>
    <select id="blockYear"></select>
    <label for="blockMonth">ì›”:</label>
    <select id="blockMonth"></select>
    <button id="nextMonth">ë‹¤ìŒ ë‹¬</button>
  </div>

  <div class="calendar" id="blockCalendar"></div>

  <script type="module">
    /* ---------------- Firebase ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRAOzrMccWaw-l5Z6YtHgpW9Gr80UTRhw",
      authDomain: "mealmanager-cda3b.firebaseapp.com",
      projectId: "mealmanager-cda3b"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{ /* ë©€í‹°íƒ­ ì¶©ëŒ ì‹œ ë¬´ì‹œ */ });

    /* ---------------- Gate (login â†’ domain â†’ admin) ---------------- */
    async function gateAdmin() {
      const user = await new Promise(resolve => {
        const un = onAuthStateChanged(auth, u => { un(); resolve(u); });
      });
      if (!user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href="index.html"; throw new Error("not signed in"); }
      const email = user.email || "";
      if (!/@sungil-i\.kr$/i.test(email)) {
        alert("êµë‚´ ê³„ì •(@sungil-i.kr)ìœ¼ë¡œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        await signOut(auth); location.href="index.html"; throw new Error("wrong domain");
      }
      const roleSnap = await getDoc(doc(db, "roles", email));
      if (!(roleSnap.exists() && roleSnap.data().role === "admin")) {
        alert("ê´€ë¦¬ì ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤."); location.href="meal.html"; throw new Error("not admin");
      }
      return email;
    }

    /* ---------------- DOM ---------------- */
    const now = new Date();
    const currentYear = now.getFullYear();

    const yearSelect = document.getElementById("yearSelect");
    const monthGrid = document.getElementById("monthGrid");
    const teacherYearSelect = document.getElementById("teacherYearSelect");
    const saveTeacherYearBtn = document.getElementById("saveTeacherYear");

    const blockYear = document.getElementById("blockYear");
    const blockMonth = document.getElementById("blockMonth");
    const blockCalendar = document.getElementById("blockCalendar");
    const prevBtn = document.getElementById("prevMonth");
    const nextBtn = document.getElementById("nextMonth");
    const syncHint = document.getElementById("syncHint");

    /* ---------------- Utils ---------------- */
    function debounce(fn, ms=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
    function populateYearOptions(selectEl) {
      selectEl.innerHTML = "";
      for (let y = currentYear - 1; y <= currentYear + 1; y++) {
        const opt = document.createElement("option");
        opt.value = y; opt.textContent = `${y}ë…„`;
        if (y === currentYear) opt.selected = true;
        selectEl.appendChild(opt);
      }
    }

    /* ---------------- Month actives: cache-first ---------------- */
    function drawMonthButtons(year, activeMonths = []) {
      monthGrid.innerHTML = "";
      const set = new Set(activeMonths);
      for (let m=1; m<=12; m++){
        const btn = document.createElement("button");
        btn.textContent = `${m}ì›”`;
        if (set.has(m)) btn.classList.add("active");

        // ë‚™ê´€ì  ì—…ë°ì´íŠ¸ + ìºì‹œ ê°±ì‹ 
        btn.onclick = async () => {
          const willActive = !btn.classList.contains("active");
          btn.classList.toggle("active");
          const key = `settings:${year}`;
          const arr = JSON.parse(localStorage.getItem(key) || "[]");
          const s = new Set(arr);
          willActive ? s.add(m) : s.delete(m);
          localStorage.setItem(key, JSON.stringify([...s]));
          // ì„œë²„ ë°˜ì˜
          await setDoc(doc(db,"mealSettings",`${year}-${m}`), { active: willActive });
        };

        monthGrid.appendChild(btn);
      }
    }

    async function renderMonthButtons() {
      const y = parseInt(yearSelect.value);
      const cacheKey = `settings:${y}`;
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        drawMonthButtons(y, JSON.parse(cached));   // ì¦‰ì‹œ
      } else {
        drawMonthButtons(y, []);                    // ê³¨ê²© ë¨¼ì €
      }

      // ì„œë²„ ìµœì‹ ê°’ìœ¼ë¡œ ê°±ì‹ 
      const snaps = await Promise.all(
        Array.from({length:12}, (_,i)=> getDoc(doc(db,"mealSettings",`${y}-${i+1}`)))
      );
      const actives = snaps.map((s,i)=> s.exists() && s.data().active ? (i+1) : null).filter(Boolean);
      localStorage.setItem(cacheKey, JSON.stringify(actives));
      drawMonthButtons(y, actives);                 // ì¡°ìš©íˆ ì—…ë°ì´íŠ¸
    }

    /* ---------------- Blocked days: cache-first ---------------- */
    function buildCalendarUI({year, month, blocked, notes, onChange}) {
      blockCalendar.innerHTML = "";
      const frag = document.createDocumentFragment();

      const weekdays = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      weekdays.forEach(day => {
        const cell = document.createElement("div");
        cell.textContent = day; cell.className = "weekday";
        frag.appendChild(cell);
      });

      const daysInMonth = new Date(year, month, 0).getDate();
      const startDay = new Date(year, month - 1, 1).getDay();
      for (let i = 0; i < startDay; i++) {
        const hole = document.createElement("div"); hole.className="skel"; frag.appendChild(hole);
      }

      const blockedSet = new Set(blocked);
      for (let d=1; d<=daysInMonth; d++){
        const date = new Date(year, month-1, d);
        const isWeekend = (date.getDay()===0 || date.getDay()===6);

        const cell = document.createElement("div");
        if (isWeekend){
          cell.textContent = `${String(d).padStart(2,'0')}ì¼`;
          cell.classList.add("disabled"); frag.appendChild(cell); continue;
        }

        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type="checkbox"; checkbox.value=d; checkbox.checked = blockedSet.has(d);

        const textSpan = document.createElement("span");
        textSpan.textContent = ` ${String(d).padStart(2,'0')}ì¼`;

        const noteInput = document.createElement("input");
        noteInput.type="text"; noteInput.className="note-input";
        noteInput.placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê¸‰ì‹ë¯¸ì‹¤ì‹œì¼)";
        noteInput.value = notes[d] ?? "ê¸‰ì‹ë¯¸ì‹¤ì‹œì¼";
        noteInput.style.display = checkbox.checked ? "block" : "none";
        if (checkbox.checked) cell.classList.add("disabled");

        checkbox.onchange = () => {
          const n = Number(checkbox.value);
          if (checkbox.checked){
            blockedSet.add(n); cell.classList.add("disabled");
            notes[n] = noteInput.value || "ê¸‰ì‹ë¯¸ì‹¤ì‹œì¼"; noteInput.style.display="block";
          } else {
            blockedSet.delete(n); cell.classList.remove("disabled");
            delete notes[n]; noteInput.style.display="none";
          }
          onChange([...blockedSet], {...notes});
        };

        noteInput.oninput = (e) => {
          const v = e.target.value.trim();
          notes[d] = v || "ê¸‰ì‹ë¯¸ì‹¤ì‹œì¼";
          if (checkbox.checked) onChange([...blockedSet], {...notes});
        };

        label.appendChild(checkbox); label.appendChild(textSpan);
        cell.appendChild(label); cell.appendChild(noteInput);
        frag.appendChild(cell);
      }

      blockCalendar.appendChild(frag);
    }

    async function renderBlockedCalendar() {
      const year  = parseInt(blockYear.value);
      const month = parseInt(blockMonth.value);
      const docId = `${year}-${String(month).padStart(2,'0')}`;
      const blockRef = doc(db, "blockedDays", docId);

      // ìºì‹œ í‚¤
      const cacheKey = `blocked:${docId}`;

      // ğŸ”§ ì €ì¥ í•¨ìˆ˜ë“¤ì„ ë¨¼ì € ì •ì˜í•˜ê³ (ìˆœì„œ ì¤‘ìš”!)
      async function saveOnce(nextBlocked, nextNotes){
        localStorage.setItem(cacheKey, JSON.stringify({blocked: nextBlocked, notes: nextNotes}));
        await setDoc(blockRef, { days: nextBlocked, notes: nextNotes }); // ì „ì²´ ë™ê¸°í™”
      }
      const saveDebounced = debounce(saveOnce, 300);

      // ìºì‹œ ë¨¼ì € ì½ì–´ UI ê·¸ë¦¼
      let blocked = [], notes = {};
      const cached = localStorage.getItem(cacheKey);
      if (cached) ({blocked, notes} = JSON.parse(cached));
      buildCalendarUI({ year, month, blocked, notes, onChange: saveDebounced }); // âœ… ì´ì œ ì •ì˜ í›„ ì „ë‹¬

      // ì„œë²„ ìµœì‹ ê°’ìœ¼ë¡œ ê°±ì‹ 
      syncHint.style.display = "inline";
      const snap = await getDoc(blockRef);
      if (snap.exists()){
        blocked = snap.data().days  || [];
        notes   = snap.data().notes || {};
        localStorage.setItem(cacheKey, JSON.stringify({blocked, notes}));
        buildCalendarUI({ year, month, blocked, notes, onChange: saveDebounced });
      }
      syncHint.style.display = "none";
    }


    /* ---------------- Teacher year ---------------- */
    async function loadTeacherYear() {
      // ìºì‹œ ë¨¼ì €
      const cacheKey = "teacherYear";
      const cached = localStorage.getItem(cacheKey);
      if (cached) teacherYearSelect.value = JSON.parse(cached);

      // ì„œë²„ ê°±ì‹ 
      const snap = await getDoc(doc(db,"mealConfig","teacherYear"));
      const y = snap.exists() ? (snap.data().year ?? currentYear) : currentYear;
      teacherYearSelect.value = y;
      localStorage.setItem(cacheKey, JSON.stringify(y));
    }
    saveTeacherYearBtn.onclick = async () => {
      const y = parseInt(teacherYearSelect.value);
      localStorage.setItem("teacherYear", JSON.stringify(y));
      await setDoc(doc(db,"mealConfig","teacherYear"), { year: y }, { merge:true });
      alert("êµì‚¬ ì‹ ì²­ìš© ì—°ë„ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    };

    /* ---------------- Events ---------------- */
    yearSelect.addEventListener("change", ()=> renderMonthButtons().catch(console.error));
    blockYear.addEventListener("change", ()=> renderBlockedCalendar().catch(console.error));
    blockMonth.addEventListener("change", ()=> renderBlockedCalendar().catch(console.error));
    prevBtn.onclick = () => {
      let y = parseInt(blockYear.value), m = parseInt(blockMonth.value) - 1;
      if (m===0){ m=12; y--; } blockYear.value = y; blockMonth.value = m;
      renderBlockedCalendar().catch(console.error);
    };
    nextBtn.onclick = () => {
      let y = parseInt(blockYear.value), m = parseInt(blockMonth.value) + 1;
      if (m===13){ m=1; y++; } blockYear.value = y; blockMonth.value = m;
      renderBlockedCalendar().catch(console.error);
    };

    /* ---------------- Init (after gate) ---------------- */
    (async function start(){
      try {
        await gateAdmin();
        populateYearOptions(yearSelect);
        populateYearOptions(blockYear);

        // ì›” select ë¯¸ë¦¬ ì±„ìš°ê¸°
        blockMonth.innerHTML = "";
        for (let m=1; m<=12; m++){
          const opt=document.createElement("option"); opt.value=m; opt.textContent=`${m}ì›”`; blockMonth.appendChild(opt);
        }
        blockYear.value = currentYear;
        blockMonth.value = now.getMonth()+1;

        // ìºì‹œ ì¦‰ì‹œ ë Œë” â†’ ì„œë²„ ê°±ì‹ 
        await Promise.all([
          renderMonthButtons(),
          renderBlockedCalendar(),
          loadTeacherYear()
        ]);
      } catch (e) {
        console.error(e);
      }
    })();
  </script>
</body>
</html>
