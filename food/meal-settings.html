<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>급식 신청 설정</title>
  <style>
    body {
      width: 100%;
      max-width: 800px;
      margin: 50px auto 0 auto;
      font-family: 'Pretendard', sans-serif;
    }
    h2 + p {
      color: #444;
      text-decoration: underline;
    }
    .select-wrapper {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }
    .month-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .month-grid button {
      padding: 10px;
      border-radius: 8px;
      font-size: 1em;
      background: #eeeeee;
      cursor: pointer;
    }
    .month-grid button.active {
      background: #1976d2;
      color: white;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      max-width: 800px;
      margin: 20px auto;
    }
    .calendar div {
      padding: 10px 5px;
      height: 60px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .calendar .weekday {
      font-weight: bold;
      background: #f0f0f0;
      color: #333;
      height: 10px;
    }
    .calendar .weekday:nth-child(1) {
      color: #e24666;
    }
    .calendar .weekday:nth-child(7) {
      color: #0080ff;
    }
    .calendar .disabled {
      color: #ccc;
    }
    .nav-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }
    .note-input {
      display:block;
      width:80%;
      margin-top:6px;
      padding:6px 8px;
      border:1px solid #ccc;
      border-radius:6px;
      font-size:0.9em;
      background:#fafafa;
    }
  </style>
</head>
<body>
  <h2>1. 급식 신청 가능 월 설정</h2>
  <p>급식 신청 가능한 연도와 월을 지정할 수 있습니다.</p>

  <div class="select-wrapper">
    <label for="yearSelect">연도 선택:</label>
    <select id="yearSelect"></select>

    <label for="teacherYearSelect" style="margin-left: 20px;">교사 신청 연도:</label>
    <select id="teacherYearSelect">
      <option value="2025">2025년</option>
      <option value="2026">2026년</option>
    </select>
    <button id="saveTeacherYear">저장</button>
  </div>
  <div class="month-grid" id="monthGrid"></div>

  <h2 style="margin-top: 40px;">2. 급식 신청 불가 일 설정</h2>
  <p>선택한 날은 급식을 신청할 수 없습니다.</p>

  <div class="select-wrapper">
    <button id="prevMonth">지난 달</button>
    <label for="blockYear">연도: </label>
    <select id="blockYear"></select>
    <label for="blockMonth">월: </label>
    <select id="blockMonth"></select>
    <button id="nextMonth">다음 달</button>
  </div>
  <div class="calendar" id="blockCalendar"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRAOzrMccWaw-l5Z6YtHgpW9Gr80UTRhw",
      authDomain: "mealmanager-cda3b.firebaseapp.com",
      projectId: "mealmanager-cda3b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const now = new Date();
    const currentYear = now.getFullYear();

    const yearSelect = document.getElementById("yearSelect");
    const monthGrid = document.getElementById("monthGrid");
    const teacherYearSelect = document.getElementById("teacherYearSelect");
    const saveTeacherYear = document.getElementById("saveTeacherYear");

    const blockYear = document.getElementById("blockYear");
    const blockMonth = document.getElementById("blockMonth");
    const blockCalendar = document.getElementById("blockCalendar");
    const prevBtn = document.getElementById("prevMonth");
    const nextBtn = document.getElementById("nextMonth");

    function populateYearOptions(selectEl) {
      selectEl.innerHTML = "";
      for (let y = currentYear - 1; y <= currentYear + 1; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = `${y}년`;
        if (y === currentYear) opt.selected = true;
        selectEl.appendChild(opt);
      }
    }

    async function loadTeacherYear() {
      const configRef = doc(db, "mealConfig", "teacherYear");
      const snap = await getDoc(configRef);
      if (snap.exists()) {
        teacherYearSelect.value = snap.data().year;
      }
    }

    saveTeacherYear.onclick = async () => {
      const y = parseInt(teacherYearSelect.value);
      await setDoc(doc(db, "mealConfig", "teacherYear"), { year: y });
      alert("교사 신청용 연도가 저장되었습니다.");
    };

    async function renderMonthButtons() {
      const selectedYear = parseInt(yearSelect.value);
      const promises = [];
      for (let m = 1; m <= 12; m++) {
        promises.push(getDoc(doc(db, "mealSettings", `${selectedYear}-${m}`)));
      }
      const results = await Promise.all(promises);
      monthGrid.innerHTML = "";
      results.forEach((snap, i) => {
        const m = i + 1;
        const settingsRef = doc(db, "mealSettings", `${selectedYear}-${m}`);
        const btn = document.createElement("button");
        btn.textContent = `${m}월`;
        if (snap.exists() && snap.data().active) btn.classList.add("active");
        btn.onclick = async () => {
          const isActive = btn.classList.contains("active");
          await setDoc(settingsRef, { active: !isActive });
          btn.classList.toggle("active");
        };
        monthGrid.appendChild(btn);
      });
    }

    async function renderBlockedCalendar() {
      const year = parseInt(blockYear.value);
      const month = parseInt(blockMonth.value);
      const daysInMonth = new Date(year, month, 0).getDate();
      const startDay = new Date(year, month - 1, 1).getDay();

      const docId = `${year}-${String(month).padStart(2, '0')}`;
      const blockRef = doc(db, "blockedDays", docId);
      const snap = await getDoc(blockRef);
      let blocked = snap.exists() ? (snap.data().days || []) : [];
      let notes = snap.exists() ? (snap.data().notes || {}) : {};

      blockCalendar.innerHTML = "";
      const weekdays = ["일","월","화","수","목","금","토"];
      weekdays.forEach(day => {
        const cell = document.createElement("div");
        cell.textContent = day;
        cell.classList.add("weekday");
        blockCalendar.appendChild(cell);
      });
      for (let i = 0; i < startDay; i++) blockCalendar.appendChild(document.createElement("div"));

      // ✅ 백필할 항목을 모아 한 번만 저장
      const backfill = {};

      const persist = async () => {
        await setDoc(blockRef, { days: blocked, notes }, { merge: true });
      };

      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month - 1, d);
        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
        const cell = document.createElement("div");

        if (isWeekend) {
          cell.textContent = `${String(d).padStart(2, '0')}일`;
          cell.classList.add("disabled");
          blockCalendar.appendChild(cell);
          continue;
        }

        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = d;
        checkbox.checked = blocked.includes(d);

        const textSpan = document.createElement("span");
        textSpan.textContent = ` ${String(d).padStart(2, '0')}일`;

        const noteInput = document.createElement("input");
        noteInput.type = "text";
        noteInput.className = "note-input";
        noteInput.placeholder = "메모를 입력하세요 (예: 급식미실시일)";
        noteInput.value = notes[d] ?? "급식미실시일";
        noteInput.style.display = checkbox.checked ? "block" : "none";

        if (checkbox.checked) {
          if (!blocked.includes(d)) blocked.push(d);
          cell.classList.add("disabled");
          const val = noteInput.value || "급식미실시일";
          notes[d] = val;
          noteInput.style.display = "block";

          await updateDoc(blockRef, {
            days: blocked,
            [`notes.${d}`]: val
          });
        }

        checkbox.onchange = async () => {
          if (checkbox.checked) {
            if (!blocked.includes(d)) blocked.push(d);
            cell.classList.add("disabled");
            if (!notes[d]) notes[d] = noteInput.value || "급식미실시일";
            noteInput.style.display = "block";
          } else {
            blocked = blocked.filter(day => day !== d);
            cell.classList.remove("disabled");
            noteInput.style.display = "none";

            // 메모 삭제 (중첩 필드 정확히 삭제)
            delete notes[d]; // 로컬 상태도 정리
            await updateDoc(blockRef, {
              days: blocked,
              [`notes.${d}`]: deleteField()
            });
          }
          await persist();
        };

        noteInput.oninput = async (e) => {
          const v = e.target.value.trim();
          notes[d] = v || "급식미실시일";
          await persist();
        };

        label.appendChild(checkbox);
        label.appendChild(textSpan);
        cell.appendChild(label);
        cell.appendChild(noteInput);
        blockCalendar.appendChild(cell);
      }

      // ✅ 렌더 종료 시, 백필할 게 있으면 한 번만 저장
      if (Object.keys(backfill).length > 0) {
        await setDoc(blockRef, { notes: backfill }, { merge: true });
      }
    }

    yearSelect.addEventListener("change", renderMonthButtons);
    blockYear.addEventListener("change", renderBlockedCalendar);
    blockMonth.addEventListener("change", renderBlockedCalendar);

    prevBtn.onclick = () => {
      let y = parseInt(blockYear.value);
      let m = parseInt(blockMonth.value);
      m--;
      if (m === 0) {
        m = 12;
        y--;
      }
      blockYear.value = y;
      blockMonth.value = m;
      renderBlockedCalendar();
    };

    nextBtn.onclick = () => {
      let y = parseInt(blockYear.value);
      let m = parseInt(blockMonth.value);
      m++;
      if (m === 13) {
        m = 1;
        y++;
      }
      blockYear.value = y;
      blockMonth.value = m;
      renderBlockedCalendar();
    };

    function init() {
      populateYearOptions(yearSelect);
      populateYearOptions(blockYear);
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = `${m}월`;
        blockMonth.appendChild(opt);
      }
      blockYear.value = currentYear;
      blockMonth.value = now.getMonth() + 1;
      renderMonthButtons();
      renderBlockedCalendar();
      loadTeacherYear();
    }

    init();
  </script>
</body>
</html>
