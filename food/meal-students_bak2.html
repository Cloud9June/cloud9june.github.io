<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>학생 급식 인원 확인</title>
  <style>
    body { max-width: 880px; margin: 40px auto; font-family: Arial, sans-serif; }
    h2 { margin-top: 36px; }
    .form { display: flex; gap: 12px; align-items: center; margin-bottom: 18px; flex-wrap: wrap; }
    .form label { display: flex; align-items: center; gap: 6px; }
    input[type="number"], select { padding: 6px 8px; }
    #legend { display: flex; gap: 14px; font-size: 14px; margin: 10px 0 4px; color:#555; }
    #legend span { display: inline-flex; align-items: center; gap:6px; }
    #legend i { width: 14px; height: 14px; display:inline-block; border:1px solid #ddd; border-radius:3px; }
    #legend i.schoolday { background:#e3f2fd; border-color:#cfe3fa; }
    #legend i.weekend { background:#f8f8f8; border-color:#eee; }
    #legend i.disabled { background:#eee; }
    #calendar { display: flex; flex-direction: column; gap: 6px; }
    .weekdays, .calendar-row { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 6px; }
    .weekday { font-weight: 600; color:#444; }
    .calendar-cell {
      min-height: 84px; padding: 8px; border: 1px solid #ddd; background:#fff; border-radius: 10px;
      display: flex; flex-direction: column; justify-content: space-between; align-items: center;
      transition: box-shadow .2s ease, transform .05s ease;
    }
    .calendar-cell .date { font-weight: 700; }
    
    .count-wrap {
      display: flex;
      flex-direction: column;   /* 숫자 1줄, 버튼 1줄 */
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }

    .count { 
      font-size: 14px; 
      color:#1976d2; 
      min-width: auto;          /* 고정폭 제거 → 가로로 커지지 않도록 */
      text-align: center; 
      cursor: pointer; 
    }

    /* 버튼들은 한 줄에 모아 중앙 정렬 */
    .controls {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .pm-btn {
      width: 24px; 
      height: 24px; 
      border: 1px solid #cfe3fa; 
      background:#e3f2fd; 
      border-radius: 50%;
      font-weight: 700; 
      line-height: 22px; 
      cursor: pointer; 
      user-select: none;
    }

    .edit-icon { 
      font-size: 12px; 
      color:#888; 
      cursor: pointer; 
      user-select: none; 
    }

    .calendar-cell.schoolday { background: #e3f2fd; border-color:#cfe3fa; }
    .calendar-cell.schoolday:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
    .calendar-cell.disabled { background:#eee; color:#999; font-weight: 600; }
    .calendar-cell.empty { background:#f7f7f7; border-style: dashed; }
    .calendar-cell.weekend { background:#f8f8f8; color:#d32f2f; }
    .calendar-cell.weekend.disabled { background:#e0e0e0; color:#a66; }
    #monthTitle { font-weight: bold; margin: 6px 0 10px; }
    .hint { font-size: 13px; color:#666; margin-top: 6px; }
    #saveBtn {background: #ffebee; border: 1px solid #1976d2; color: blue; padding: 5px;}
    #resetBtn {background:#ffebee; border:1px solid #e57373; color:#c62828; padding: 5px;}
  </style>
</head>
<body>
  <h2>1. 학생 인원 등록 및 월 일괄 저장</h2>
  <div class="form">
    <label>연도: <select id="yearSelect"></select></label>
    <label>월: <select id="monthSelect"></select></label>
    <label>인원수: <input type="number" id="studentCount" placeholder="예: 320" min="0" /></label>
    <button id="saveBtn">저장(등교일 전체 채우기)</button>
    <button id="resetBtn">초기화</button>
  </div>

  <h2>2. 학생 급식 인원 확인/수정</h2>
  <div id="monthTitle"></div>
  <div id="legend">
    <span><i class="schoolday"></i>등교일(수정 가능)</span>
    <span><i class="weekend"></i>주말</span>
    <span><i class="disabled"></i>급식미실시</span>
  </div>
  <div id="calendar"></div>
  <div class="hint">Tip: 숫자를 클릭하면 직접 입력, 좌우 ± 버튼으로 1명씩 조정할 수 있어요.</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyBRAOzrMccWaw-l5Z6YtHgpW9Gr80UTRhw",
      authDomain: "mealmanager-cda3b.firebaseapp.com",
      projectId: "mealmanager-cda3b"
    };

    // 초기화
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 요소
    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");
    const studentCountInput = document.getElementById("studentCount");
    const saveBtn = document.getElementById("saveBtn");
    const resetBtn = document.getElementById("resetBtn");
    const calendar = document.getElementById("calendar");
    const monthTitle = document.getElementById("monthTitle");

    // 날짜 기본값
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    // 연/월 옵션 구성
    for (let y = currentYear - 1; y <= currentYear + 1; y++) {
      const opt = new Option(`${y}년`, y);
      if (y === currentYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }
    for (let m = 1; m <= 12; m++) {
      const opt = new Option(`${m}월`, m);
      if (m === currentMonth) opt.selected = true;
      monthSelect.appendChild(opt);
    }

    // 유틸
    const pad2 = (n) => String(n).padStart(2, "0");
    const monthId = (y,m) => `${y}-${pad2(m)}`;
    const studentsDailyRef = (y,m) => doc(db, "studentsDaily", monthId(y,m)); // 월별 일자 맵 저장
    const blockedDaysRef  = (y,m) => doc(db, "blockedDays" , monthId(y,m));  // 급식미실시 일자 배열

    async function fetchBlockedDays(year, month) {
      const snap = await getDoc(blockedDaysRef(year, month));
      if (snap.exists() && Array.isArray(snap.data().days)) {
        return snap.data().days.map(Number);
      }
      return [];
    }

    async function fetchMonthDays(year, month) {
      const snap = await getDoc(studentsDailyRef(year, month));
      if (snap.exists() && snap.data().days && typeof snap.data().days === "object") {
        return snap.data().days; // { "1": 320, "2": 320, ... }
      }
      return {};
    }

    // 등교일(주말/급식미실시 제외) 전체 채우기
    async function saveMonthAllSchoolDays(year, month, value) {
      const startDate = new Date(year, month - 1, 1);
      const endDate = new Date(year, month, 0);
      const firstDayIndex = startDate.getDay();
      const lastDate = endDate.getDate();
      const blocked = await fetchBlockedDays(year, month);
      const daysMap = {};

      for (let d = 1; d <= lastDate; d++) {
        const dow = (firstDayIndex + d - 1) % 7;        // 0=일, 6=토
        const isWeekend = (dow === 0 || dow === 6);
        const isBlocked = blocked.includes(d);
        if (!isWeekend && !isBlocked) {
          daysMap[String(d)] = value;
        }
      }
      await setDoc(studentsDailyRef(year, month), { days: daysMap }, { merge: true });
    }

    // 단일 날짜 저장(문서 읽기 없이 병합)
    async function updateSingleDay(year, month, day, value) {
      const n = Math.max(0, parseInt(value || 0, 10)); // 음수 방지
      await setDoc(
        studentsDailyRef(year, month),
        { days: { [String(day)]: n } },
        { merge: true }
      );
    }

    function makeCountArea(year, month, day, currentVal, onChanged) {
      const wrap = document.createElement("div");
      wrap.className = "count-wrap";

      const num = document.createElement("div");
      num.className = "count";
      num.textContent = (currentVal ?? 0) + "명";
      num.title = "클릭하여 직접 입력";

      const controls = document.createElement("div");
      controls.className = "controls";

      const minus = document.createElement("button");
      minus.className = "pm-btn";
      minus.textContent = "−";

      const edit = document.createElement("span");
      edit.className = "edit-icon";
      edit.textContent = "✎";

      const plus = document.createElement("button");
      plus.className = "pm-btn";
      plus.textContent = "+";

      // 공통: Firestore 반영 + 화면 업데이트(낙관적)
      const applyChange = async (next) => {
        num.textContent = `${next}명`;
        await updateSingleDay(year, month, day, next);
        onChanged(next);
      };

      minus.addEventListener("click", async (e) => {
        e.stopPropagation();
        const curr = parseInt((num.textContent || "0").replace("명","")) || 0;
        await applyChange(Math.max(0, curr - 1));
      });

      plus.addEventListener("click", async (e) => {
        e.stopPropagation();
        const curr = parseInt((num.textContent || "0").replace("명","")) || 0;
        await applyChange(curr + 1);
      });

      const openPrompt = async (e) => {
        e.stopPropagation();
        const curr = parseInt((num.textContent || "0").replace("명","")) || 0;
        const input = prompt(`${year}년 ${month}월 ${day}일 인원수`, curr);
        if (input === null) return;
        const n = parseInt(input, 10);
        if (isNaN(n) || n < 0) { alert("유효한 숫자를 입력하세요."); return; }
        await applyChange(n);
      };
      num.addEventListener("click", openPrompt);
      edit.addEventListener("click", openPrompt);

      controls.appendChild(minus);
      controls.appendChild(edit);
      controls.appendChild(plus);

      wrap.appendChild(num);       // 1줄: 320명
      wrap.appendChild(controls);  // 2줄: − ✎ +
      return wrap;
    }


    async function renderCalendar() {
      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);
      calendar.innerHTML = "";

      const startDate = new Date(year, month - 1, 1);
      const endDate = new Date(year, month, 0);
      const firstDayIndex = startDate.getDay(); // 0: Sun ... 6: Sat
      const lastDate = endDate.getDate();

      const [blocked, monthDays] = await Promise.all([
        fetchBlockedDays(year, month),
        fetchMonthDays(year, month)
      ]);

      monthTitle.textContent = `${year}년 ${month}월`;

      const daysOfWeek = ["일", "월", "화", "수", "목", "금", "토"];
      const header = document.createElement("div");
      header.className = "weekdays";
      daysOfWeek.forEach(d => {
        const cell = document.createElement("div");
        cell.className = "weekday";
        cell.textContent = d;
        header.appendChild(cell);
      });
      calendar.appendChild(header);

      let dateNum = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement("div");
        row.className = "calendar-row";

        for (let j = 0; j < 7; j++) {
          const cell = document.createElement("div");
          cell.className = "calendar-cell";

          if (i === 0 && j < firstDayIndex) {
            cell.classList.add("empty");
          } else if (dateNum <= lastDate) {
            const dow = (firstDayIndex + dateNum - 1) % 7;
            const isWeekend = (dow === 0 || dow === 6);
            const isBlocked = blocked.includes(dateNum);
            const dayKey = String(dateNum);
            let count = monthDays[dayKey] ?? 0;

            const dateEl = document.createElement("div");
            dateEl.className = "date";
            dateEl.textContent = dateNum;

            cell.appendChild(dateEl);

            if (isWeekend) cell.classList.add("weekend");
            if (isWeekend || isBlocked) {
              cell.classList.add("disabled");
              const info = document.createElement("div");
              info.style.fontSize = "13px";
              info.style.color = "#888";
              info.textContent = isWeekend ? "" : "급식미실시";
              cell.appendChild(info);
            } else {
              cell.classList.add("schoolday");
              // 카운트 UI(± 버튼 + 숫자 + ✎)
              const countWrap = makeCountArea(
                year, month, dateNum, count,
                (next) => { monthDays[dayKey] = next; } // 로컬 상태 업데이트
              );
              cell.appendChild(countWrap);
            }

            dateNum++;
          } else {
            cell.classList.add("empty");
          }
          row.appendChild(cell);
        }

        calendar.appendChild(row);
        if (dateNum > lastDate) break;
      }
    }

    // 이벤트
    saveBtn.addEventListener("click", async () => {
      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);
      const count = parseInt(studentCountInput.value, 10);
      if (isNaN(count) || count < 0) {
        alert("유효한 학생 수를 입력하세요.");
        return;
      }
      await saveMonthAllSchoolDays(year, month, count);
      alert("저장되었습니다. (등교일 전체 채움)");
      await renderCalendar();
    });

    resetBtn.addEventListener("click", async () => {
      if (!confirm("정말로 이 달의 모든 등교일 인원을 0명으로 초기화하시겠습니까?")) return;
      
      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);
      
      await saveMonthAllSchoolDays(year, month, 0);
      alert("초기화 완료되었습니다. (등교일 전체 0명)");
      await renderCalendar();
    });

    yearSelect.addEventListener("change", renderCalendar);
    monthSelect.addEventListener("change", renderCalendar);

    // 초기 렌더
    window.addEventListener("load", renderCalendar);
  </script>
</body>
</html>
