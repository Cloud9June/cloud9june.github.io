<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>ê¸‰ì‹ ì‹ ì²­ ì¸ì› í™•ì¸</title>
  <style>
    body {
      width: 100%;
      max-width: 900px;
      margin: 50px auto;
      font-family: sans-serif;
    }

    h2 {
      margin-top: 50px;
    }

    .filters {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filters label {
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #1976d2;
      color: white;
    }

    td:nth-child(3) {
      text-align: left;
    }

    td label {
      display: inline-block;
      margin: 2px 15px;
      white-space: nowrap;
      width: 40px;
    }

    .summary {
      font-weight: bold;
      margin-top: 10px;
      text-align: right;
    }
  </style>
</head>

<body>
  <h2>1. ê¸‰ì‹ ì‹ ì²­ ì¸ì› í™•ì¸</h2>
  <p>ì—°ë„, ì›”, ë‚ ì§œ, ì´ë¦„ìœ¼ë¡œ ê¸‰ì‹ ì‹ ì²­ ì •ë³´ë¥¼ í•„í„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  <div class="filters">
    <label>ì—°ë„: <select id="yearSelect"></select></label>
    <label>ì›”: <select id="monthSelect"></select></label>
    <label>ë‚ ì§œ: <select id="daySelect">
        <option value="">ì „ì²´</option>
      </select></label>
    <label>ì´ë¦„ ê²€ìƒ‰: <input type="text" id="nameSearch" placeholder="ì´ë¦„ ì…ë ¥"></label>
    <button id="searchBtn">ê²€ìƒ‰</button>
  </div>

  <div class="summary" id="summaryText">ì‹ ì²­ ì¸ì›: 0ëª…</div>
  <table>
    <colgroup>
      <col style="width: 20%;">
      <col style="width: 30%;">
      <col style="width: 50%;">
    </colgroup>
    <thead>
      <tr>
        <th>ì´ë¦„</th>
        <th>ì´ë©”ì¼</th>
        <th>ì‹ ì²­ ë‚ ì§œ</th>
      </tr>
    </thead>
    <tbody id="dataTable"></tbody>
  </table>

  <h2>2. ê¸‰ì‹ ë¯¸ì‹ ì²­ ì¸ì› í™•ì¸</h2>
  <p>ì„ íƒëœ ì—°ë„ì™€ ì›”ì— ê¸‰ì‹ì„ ì‹ ì²­í•˜ì§€ ì•Šì€ êµì§ì› ëª©ë¡ì…ë‹ˆë‹¤.</p>
  <div class="summary" id="nonSummaryText">ë¯¸ì‹ ì²­ ì¸ì›: 0ëª…</div>
  <table>
    <colgroup>
      <col style="width: 30%;">
      <col style="width: 70%;">
    </colgroup>
    <thead>
      <tr>
        <th>ì´ë¦„</th>
        <th>ì´ë©”ì¼</th>
      </tr>
    </thead>
    <tbody id="nonAppliedTable"></tbody>
  </table>

  <h2>3. ê¸‰ì‹ ì¶”ê°€ ì‹ ì²­</h2>
  <p>êµì‚¬ ì´ë¦„ê³¼ ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ê¸‰ì‹ ì‹ ì²­ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  <div class="filters">
    <label>êµì‚¬ ì„ íƒ:
      <select id="teacherSelect">
        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </label>
    <label>ë‚ ì§œ ì„ íƒ:
      <input type="date" id="addDate">
    </label>
    <button id="addBtn">ì‹ ì²­</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, query, where, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRAOzrMccWaw-l5Z6YtHgpW9Gr80UTRhw",
      authDomain: "mealmanager-cda3b.firebaseapp.com",
      projectId: "mealmanager-cda3b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---------- DOM ----------
    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");
    const daySelect = document.getElementById("daySelect");
    const nameSearch = document.getElementById("nameSearch");
    const dataTable = document.getElementById("dataTable");
    const nonAppliedTable = document.getElementById("nonAppliedTable");
    const summaryText = document.getElementById("summaryText");
    const nonSummaryText = document.getElementById("nonSummaryText");
    const searchBtn = document.getElementById("searchBtn");
    const teacherSelect = document.getElementById("teacherSelect");
    const addDate = document.getElementById("addDate");
    const addBtn = document.getElementById("addBtn");

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    function populateOptions() {
      for (let y = currentYear - 1; y <= currentYear + 1; y++) {
        const opt = new Option(`${y}ë…„`, y);
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }
      for (let m = 1; m <= 12; m++) {
        const opt = new Option(`${m}ì›”`, m);
        if (m === currentMonth) opt.selected = true;
        monthSelect.appendChild(opt);
      }
      for (let d = 1; d <= 31; d++) {
        daySelect.appendChild(new Option(`${d}ì¼`, d));
      }
    }

// ---------- ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ----------
async function loadData() {
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);
  const day = parseInt(daySelect.value);
  const name = nameSearch.value.trim();

  const ym = `${year}-${String(month).padStart(2, "0")}`; // "2025-08"
  const snapshot = await getDocs(collection(db, "mealRequests", ym, "users"));

  let appliedCount = 0;
  let nonAppliedCount = 0;
  dataTable.innerHTML = "";
  nonAppliedTable.innerHTML = "";

  for (const docSnap of snapshot.docs) {
    const data = docSnap.data();

    // ë¯¸ì‹ ì²­ì
    if (!Array.isArray(data.days) || data.days.length === 0) {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${data.name}</td><td>${data.email}</td>`;
      nonAppliedTable.appendChild(row);
      nonAppliedCount++;
      continue;
    }

    // í•„í„°
    if (name && !String(data.name || "").includes(name)) continue;
    if (day && !data.days.includes(day)) continue;

    // ì‹ ì²­ì
    const row = document.createElement("tr");
    row.innerHTML = `<td>${data.name}</td><td>${data.email}</td>`;

    const dateCell = document.createElement("td");
    [...data.days].sort((a, b) => a - b).forEach(d => {
      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = true;
      checkbox.dataset.uid = docSnap.id;
      checkbox.dataset.day = d;

      checkbox.onchange = async () => {
        if (!checkbox.checked && confirm(`${month}ì›” ${d}ì¼ ê¸‰ì‹ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          const ref = doc(db, "mealRequests", ym, "users", docSnap.id);
          const fresh = await getDoc(ref);
          if (fresh.exists()) {
            const updatedDays = (fresh.data().days || []).filter(x => x !== d);
            await setDoc(ref, { ...fresh.data(), days: updatedDays }, { merge: true });
            alert(`${month}ì›” ${d}ì¼ ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            loadData();
          }
        } else {
          checkbox.checked = true;
        }
      };

      label.appendChild(checkbox);
      label.append(` ${d}ì¼`);
      dateCell.appendChild(label);
    });

    row.appendChild(dateCell);
    dataTable.appendChild(row);
    appliedCount++;
  }

  summaryText.textContent = `ì‹ ì²­ ì¸ì›: ${appliedCount}ëª…`;
  nonSummaryText.textContent = `ë¯¸ì‹ ì²­ ì¸ì›: ${nonAppliedCount}ëª…`;
}

// ---------- êµì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ----------
async function loadTeachers(year, month) {
  teacherSelect.innerHTML = `<option value="">ì„ íƒí•˜ì„¸ìš”</option>`;
  const ym = `${year}-${String(month).padStart(2, "0")}`;
  console.log("êµì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°:", ym);

  const snapshot = await getDocs(collection(db, "mealRequests", ym, "users"));

  if (snapshot.empty) {
    console.log("í•´ë‹¹ ì›”ì— ê¸‰ì‹ ì‹ ì²­í•œ êµì‚¬ê°€ ì—†ìŒ");
    return;
  }

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    console.log("êµì‚¬ ë°ì´í„°:", docSnap.id, data);

    if (!data.name || !data.email) {
      console.warn("âš ï¸ name/email ëˆ„ë½:", docSnap.id, data);
    }

    teacherSelect.appendChild(
      new Option(`${data.name} (${data.email})`, docSnap.id)
    );
  });
}


// ---------- ê¸‰ì‹ ì¶”ê°€ ì‹ ì²­ ----------
async function addMealForTeacher() {
  const docId = teacherSelect.value; // "ì´ë¦„_uid"
  const dateStr = addDate.value;
  if (!docId || !dateStr) {
    alert("êµì‚¬ì™€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  const date = new Date(dateStr);
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const ym = `${year}-${String(month).padStart(2, "0")}`;

  // ğŸ”¹ ì£¼ë§ ì²´í¬
  const dayOfWeek = date.getDay(); // 0=ì¼, 6=í† 
  if (dayOfWeek === 0 || dayOfWeek === 6) {
    alert(`${month}ì›” ${day}ì¼ì€ ì£¼ë§ì´ë¯€ë¡œ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
    return;
  }

  // ğŸ”¹ blockedDays í™•ì¸
  const blockedRef = doc(db, "blockedDays", ym);
  const blockedSnap = await getDoc(blockedRef);
  if (blockedSnap.exists()) {
    const blockedDays = blockedSnap.data().days || [];
    if (blockedDays.includes(day)) {
      alert(`${month}ì›” ${day}ì¼ì€ ê¸‰ì‹ ë¯¸ì‹¤ì‹œì¼ë¡œ ì¶”ê°€ ì‹ ì²­ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`);
      return;
    }
  }

  // ğŸ”¹ êµì‚¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  const ref = doc(db, "mealRequests", ym, "users", docId);
  const snap = await getDoc(ref);
  if (!snap.exists()) {
    alert("í•´ë‹¹ êµì‚¬ì˜ ê¸‰ì‹ ì‹ ì²­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const data = snap.data();
  if (Array.isArray(data.days) && data.days.includes(day)) {
    alert(`${month}ì›” ${day}ì¼ì€ ì´ë¯¸ ì‹ ì²­ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
    return;
  }

  if (confirm(`${data.name} ì„ ìƒë‹˜ ${month}ì›” ${day}ì¼ ê¸‰ì‹ì„ ì¶”ê°€ ì‹ ì²­í• ê¹Œìš”?`)) {
    const newDays = Array.from(new Set([...(data.days || []), day])).sort((a, b) => a - b);
    await setDoc(ref, { ...data, days: newDays }, { merge: true });
    alert("ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    loadData(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
  }
}

    // ---------- ê²Œì´íŠ¸: ë¡œê·¸ì¸ â†’ ë„ë©”ì¸(@sungil-i.kr) â†’ roles(admin) ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href = "index.html"; return; }
      const email = user.email || "";
      if (!/@sungil-i\.kr$/i.test(email)) {
        alert("êµë‚´ ê³„ì •(@sungil-i.kr)ìœ¼ë¡œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        await signOut(auth); location.href = "index.html"; return;
      }

      try {
        const role = await getDoc(doc(db, "roles", email));
        const isAdmin = role.exists() && role.data().role === "admin";
        if (!isAdmin) { alert("ê´€ë¦¬ì ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤."); location.href = "meal.html"; return; }
      } catch (e) {
        console.error("roles í™•ì¸ ì‹¤íŒ¨:", e);
        alert("ê¶Œí•œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return;
      }

      // âœ… ì—¬ê¸°ì„œë¶€í„° ë°ì´í„° ë¡œë”©/ì“°ê¸° í—ˆìš©
      populateOptions();
      await loadData();
      await loadTeachers(parseInt(yearSelect.value), parseInt(monthSelect.value));

      searchBtn.onclick = async () => { await loadData(); await loadTeachers(parseInt(yearSelect.value), parseInt(monthSelect.value));};
      addBtn.onclick = addMealForTeacher;
    });
  </script>

</body>

</html>
