<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>급식 신청 인원 확인</title>
  <style>
    body { width: 100%; max-width: 900px; margin: 50px auto; font-family: sans-serif; }
    h2 { margin-top: 50px; }
    .filters { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
    .filters label { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #1976d2; color: white; }
    td:nth-child(3) { text-align: left; }
    td label { display: inline-block; margin: 2px 15px; white-space: nowrap; width: 40px; }
    .summary { font-weight: bold; margin-top: 10px; text-align: right; }
  </style>
</head>
<body>
  <h2>1. 급식 신청 인원 확인</h2>
  <p>연도, 월, 날짜, 이름으로 급식 신청 정보를 필터링할 수 있습니다.</p>
  <div class="filters">
    <label>연도: <select id="yearSelect"></select></label>
    <label>월: <select id="monthSelect"></select></label>
    <label>날짜: <select id="daySelect"><option value="">전체</option></select></label>
    <label>이름 검색: <input type="text" id="nameSearch" placeholder="이름 입력"></label>
    <button id="searchBtn">검색</button>
  </div>

  <div class="summary" id="summaryText">신청 인원: 0명</div>
  <table>
    <colgroup>
      <col style="width: 20%;">
      <col style="width: 30%;">
      <col style="width: 50%;">
    </colgroup>
    <thead>
      <tr><th>이름</th><th>이메일</th><th>신청 날짜</th></tr>
    </thead>
    <tbody id="dataTable"></tbody>
  </table>

  <h2>2. 급식 미신청 인원 확인</h2>
  <p>선택된 연도와 월에 급식을 신청하지 않은 교직원 목록입니다.</p>
  <div class="summary" id="nonSummaryText">미신청 인원: 0명</div>
  <table>
    <colgroup>
      <col style="width: 30%;">
      <col style="width: 70%;">
    </colgroup>
    <thead>
      <tr><th>이름</th><th>이메일</th></tr>
    </thead>
    <tbody id="nonAppliedTable"></tbody>
  </table>

  <h2>3. 급식 추가 신청</h2>
  <p>교사 이름과 날짜를 선택하여 급식 신청을 추가할 수 있습니다.</p>
  <div class="filters">
    <label>교사 선택: 
      <select id="teacherSelect">
        <option value="">선택하세요</option>
      </select>
    </label>
    <label>날짜 선택: 
      <input type="date" id="addDate">
    </label>
    <button id="addBtn">신청</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, query, where, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRAOzrMccWaw-l5Z6YtHgpW9Gr80UTRhw",
      authDomain: "mealmanager-cda3b.firebaseapp.com",
      projectId: "mealmanager-cda3b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---------- DOM ----------
    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");
    const daySelect = document.getElementById("daySelect");
    const nameSearch = document.getElementById("nameSearch");
    const dataTable = document.getElementById("dataTable");
    const nonAppliedTable = document.getElementById("nonAppliedTable");
    const summaryText = document.getElementById("summaryText");
    const nonSummaryText = document.getElementById("nonSummaryText");
    const searchBtn = document.getElementById("searchBtn");
    const teacherSelect = document.getElementById("teacherSelect");
    const addDate = document.getElementById("addDate");
    const addBtn = document.getElementById("addBtn");

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    function populateOptions() {
      for (let y = currentYear - 1; y <= currentYear + 1; y++) {
        const opt = new Option(`${y}년`, y);
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }
      for (let m = 1; m <= 12; m++) {
        const opt = new Option(`${m}월`, m);
        if (m === currentMonth) opt.selected = true;
        monthSelect.appendChild(opt);
      }
      for (let d = 1; d <= 31; d++) {
        daySelect.appendChild(new Option(`${d}일`, d));
      }
    }

    async function loadData() {
      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);
      const day = parseInt(daySelect.value);
      const name = nameSearch.value.trim();

      const q = query(collection(db, "mealRequests"),
        where("year", "==", year),
        where("month", "==", month)
      );
      const snapshot = await getDocs(q);

      let appliedCount = 0;
      let nonAppliedCount = 0;
      dataTable.innerHTML = "";
      nonAppliedTable.innerHTML = "";

      for (const docSnap of snapshot.docs) {
        const data = docSnap.data();

        // 미신청자 표
        if (!Array.isArray(data.days) || data.days.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${data.name}</td><td>${data.email}</td>`;
          nonAppliedTable.appendChild(row);
          nonAppliedCount++;
          continue;
        }

        // 필터
        if (name && !String(data.name || "").includes(name)) continue;
        if (day && !data.days.includes(day)) continue;

        // 신청자 표
        const row = document.createElement("tr");
        row.innerHTML = `<td>${data.name}</td><td>${data.email}</td>`;

        const dateCell = document.createElement("td");
        [...data.days].sort((a, b) => a - b).forEach(d => {
          const label = document.createElement("label");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = true;
          checkbox.dataset.id = docSnap.id;
          checkbox.dataset.day = d;

          checkbox.onchange = async () => {
            // 관리자가 취소 (rules에서 admin 쓰기 허용 필요! 아래 B 참고)
            if (!checkbox.checked && confirm(`${month}월 ${d}일 급식을 정말 취소하시겠습니까?`)) {
              const ref = doc(db, "mealRequests", docSnap.id);
              const fresh = await getDoc(ref);
              if (fresh.exists()) {
                const updatedDays = (fresh.data().days || []).filter(x => x !== d);
                await setDoc(ref, { ...fresh.data(), days: updatedDays });
                alert(`${month}월 ${d}일 신청이 취소되었습니다.`);
                loadData();
              }
            } else {
              checkbox.checked = true;
            }
          };

          label.appendChild(checkbox);
          label.append(` ${d}일`);
          dateCell.appendChild(label);
        });

        row.appendChild(dateCell);
        dataTable.appendChild(row);
        appliedCount++;
      }

      summaryText.textContent = `신청 인원: ${appliedCount}명`;
      nonSummaryText.textContent = `미신청 인원: ${nonAppliedCount}명`;
    }

    async function loadTeachers() {
      teacherSelect.innerHTML = `<option value="">선택하세요</option>`;
      const snapshot = await getDocs(collection(db, "mealRequests"));
      const seen = new Set();
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const key = (data.email || "").toLowerCase();
        if (key && !seen.has(key)) {
          teacherSelect.appendChild(new Option(`${data.name} (${data.email})`, data.email));
          seen.add(key);
        }
      });
    }

    async function addMealForTeacher() {
      const email = teacherSelect.value;
      const dateStr = addDate.value;
      if (!email || !dateStr) { alert("교사와 날짜를 선택하세요."); return; }

      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();

      const q = query(collection(db, "mealRequests"),
        where("email", "==", email),
        where("year", "==", year),
        where("month", "==", month)
      );
      const snapshot = await getDocs(q);
      if (snapshot.empty) { alert("해당 교사의 급식 신청 데이터가 없습니다."); return; }

      const docSnap = snapshot.docs[0];
      const ref = doc(db, "mealRequests", docSnap.id);
      const data = docSnap.data();

      if (Array.isArray(data.days) && data.days.includes(day)) {
        alert(`${month}월 ${day}일은 이미 신청되어 있습니다.`);
        return;
      }
      if (confirm(`${data.name} 선생님 ${month}월 ${day}일 급식을 추가 신청할까요?`)) {
        const newDays = Array.from(new Set([...data.days, addedDay])).sort((a,b)=>a-b);
        await setDoc(ref, { ...data, days: newDays });
        alert("신청이 완료되었습니다.");
        loadData();
      }
    }

    // ---------- 게이트: 로그인 → 도메인(@sungil-i.kr) → roles(admin) ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user) { alert("로그인이 필요합니다."); location.href = "index.html"; return; }
      const email = user.email || "";
      if (!/@sungil-i\.kr$/i.test(email)) {
        alert("교내 계정(@sungil-i.kr)으로만 접근 가능합니다.");
        await signOut(auth); location.href = "index.html"; return;
      }

      try {
        const role = await getDoc(doc(db, "roles", email));
        const isAdmin = role.exists() && role.data().role === "admin";
        if (!isAdmin) { alert("관리자 전용 페이지입니다."); location.href = "meal.html"; return; }
      } catch (e) {
        console.error("roles 확인 실패:", e);
        alert("권한 확인에 실패했습니다."); return;
      }

      // ✅ 여기서부터 데이터 로딩/쓰기 허용
      populateOptions();
      await loadData();
      await loadTeachers();

      searchBtn.onclick = loadData;
      addBtn.onclick = addMealForTeacher;
    });
  </script>

</body>
</html>
