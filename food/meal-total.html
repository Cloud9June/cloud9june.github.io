<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¼ìë³„ ì´ ê¸‰ì‹ ì¸ì›(í•™ìƒ+êµì‚¬)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { max-width: 880px; margin: 40px auto; font-family: Arial, sans-serif; color:#222; }
    h1 { margin: 0 0 16px; font-size: 22px; }
    h2 { margin: 28px 0 10px; font-size: 18px; }
    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 10px 0 18px; }
    .toolbar label { display:flex; align-items:center; gap:6px; }
    select, button { padding: 8px 10px; font-size: 14px; }
    button { cursor:pointer; border:1px solid #cfd8dc; background:#fafafa; border-radius:8px; }
    button.primary { background:#e8f5e9; border-color:#81c784; color:#2e7d32; }
    .note { font-size:13px; color:#666; margin-top:4px; }
    .card { background:#fff; border:1px solid #e0e0e0; border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .list-wrap { max-height: 420px; overflow:auto; border:1px solid #eee; border-radius:8px; padding:10px; background:#fff; }
    .row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px dashed #eee; font-size:14px; }
    .row:last-child { border-bottom:0; }
    .date { font-weight:700; }
    .count { color:#1976d2; }

    /* Summary */
    .summary-subtitle { font-weight:700; margin: 10px 0 6px; }
    .summary-line { margin: 6px 0; }
    .summary-list { margin: 6px 0 0 18px; padding: 0; font-size: 13px; }
    .summary-list li { margin: 4px 0; }
    .pill { display:inline-block; padding:2px 8px; font-size:12px; border-radius:999px; border:1px solid #eee; background:#f7f7f7; }

    .box { padding:12px; border:1px solid #eee; border-radius:10px; background:#fafafa; margin-top:10px; }
    .muted { color:#777; font-size:13px; }
  </style>
</head>
<body>
  <h1>ì¼ìë³„ ì´ ê¸‰ì‹ ì¸ì›(í•™ìƒ+êµì‚¬)</h1>

  <div class="toolbar card">
    <label>ì—°ë„:
      <select id="yearSelect"></select>
    </label>
    <label>ì›”:
      <select id="monthSelect"></select>
    </label>

    <button id="calcBtn" class="primary">ì´ì› ê³„ì‚°/ì €ì¥</button>
    <span class="note">â€» í˜ì´ì§€ ë¡œë“œì‹œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤. ë²„íŠ¼ì€ ìˆ˜ë™ ì¬ê³„ì‚°/ì €ì¥ ìš©ë„ì…ë‹ˆë‹¤.</span>
  </div>

  <div class="grid">
    <div class="card">
      <h2 id="title">ì¶œë ¥</h2>
      <div class="list-wrap" id="totalList">
        <div class="muted">ë¡œë”© ì¤‘â€¦</div>
      </div>
    </div>
    <div class="card">
      <h2 id="summaryTitle">ìš”ì•½ - </h2>

      <!-- êµì‚¬ ë°•ìŠ¤ -->
      <div class="box" id="teacherBox">
        <div class="summary-subtitle">êµì‚¬</div>
        <div class="summary-line"><b>ë¯¸ì‹ ì²­ì ëª…ë‹¨</b></div>
        <div id="teacherNoMealNames" class="summary-line muted">ë¡œë”© ì¤‘â€¦</div>
        <div class="summary-line" style="margin-top:6px;"><b>íŠ¹ì´ì‚¬í•­</b></div>
        <div id="teacherNotesWrap" class="summary-line">
          <div class="muted">ë¡œë”© ì¤‘â€¦</div>
        </div>
      </div>

      <!-- í•™ìƒ ë°•ìŠ¤ -->
      <div class="box" id="studentBox">
        <div class="summary-subtitle">í•™ìƒ</div>
        <div class="summary-line"><b>í•™ìƒ ê¸‰ì‹ ë³€ë™ ë‚´ì—­</b></div>
        <div id="studentAdjustWrap" class="summary-line">
          <div class="muted">ë¡œë”© ì¤‘â€¦</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBRAOzrMccWaw-l5Z6YtHgpW9Gr80UTRhw",
      authDomain: "mealmanager-cda3b.firebaseapp.com",
      projectId: "mealmanager-cda3b"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db  = getFirestore(app);

    // DOM
    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");
    const calcBtn = document.getElementById("calcBtn");
    const totalList = document.getElementById("totalList");
    const title = document.getElementById("title");
    const summaryTitle = document.getElementById("summaryTitle");
    const teacherNoMealNamesEl = document.getElementById("teacherNoMealNames");
    const teacherNotesWrap = document.getElementById("teacherNotesWrap");
    const studentAdjustWrap = document.getElementById("studentAdjustWrap");

    // ê¸°ë³¸ ì—°/ì›” ì˜µì…˜
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    for (let y = currentYear - 1; y <= currentYear + 1; y++) {
      const opt = new Option(`${y}ë…„`, y);
      if (y === currentYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }
    for (let m = 1; m <= 12; m++) {
      const opt = new Option(`${m}ì›”`, m);
      if (m === currentMonth) opt.selected = true;
      monthSelect.appendChild(opt);
    }

    // utils/refs
    const pad2 = (n) => String(n).padStart(2, "0");
    const monthId = (y,m) => `${y}-${pad2(m)}`;
    const studentsDailyRef          = (y,m) => doc(db, "studentsDaily", monthId(y,m));
    const studentsDailyEffectiveRef = (y,m) => doc(db, "studentsDailyEffective", monthId(y,m));
    const blockedDaysRef            = (y,m) => doc(db, "blockedDays" , monthId(y,m));
    const totalsRef                 = (y,m) => doc(db, "totals"      , monthId(y,m));
    const mealRequestsCol           = collection(db, "mealRequests");
    const studentAbsencesRef        = (y,m) => doc(db, "studentAbsences", monthId(y,m));

    function toInt(value) {
      if (typeof value === "number") return Number.isFinite(value) ? Math.max(0, Math.floor(value)) : 0;
      if (typeof value === "string") {
        const n = parseInt(value.replace(/[^0-9]/g,""),10);
        return Number.isFinite(n) ? Math.max(0, n) : 0;
      }
      return 0;
    }

    // í•™ìƒ: ì°¨ê° ë°˜ì˜ë³¸ ìš°ì„ 
    async function fetchStudentDaysPreferEffective(year, month) {
      const eff = await getDoc(studentsDailyEffectiveRef(year, month));
      if (eff.exists() && eff.data().days && typeof eff.data().days === "object") {
        const raw = eff.data().days, normalized = {};
        for (const k of Object.keys(raw)) normalized[k] = toInt(raw[k]);
        return normalized;
      }
      const base = await getDoc(studentsDailyRef(year, month));
      if (base.exists() && base.data().days && typeof base.data().days === "object") {
        const raw = base.data().days, normalized = {};
        for (const k of Object.keys(raw)) normalized[k] = toInt(raw[k]);
        return normalized;
      }
      return {};
    }

    async function fetchBlockedDays(year, month) {
      const snap = await getDoc(blockedDaysRef(year, month));
      if (snap.exists() && Array.isArray(snap.data().days)) return snap.data().days.map(Number);
      return [];
    }

    // êµì‚¬: ë‚ ì§œë³„ í•©ê³„
    async function countTeachersPerDay(year, month) {
      try {
        const qy = query(mealRequestsCol, where("year","==",year), where("month","==",month));
        const snap = await getDocs(qy);
        return aggregateTeacherDays(snap);
      } catch (e) {
        // (í˜¹ì‹œ ì¸ë±ìŠ¤ ë¬¸ì œ ì‹œ ìš°íšŒ)
        const qYear = query(mealRequestsCol, where("year","==",year));
        const snap = await getDocs(qYear);
        const filtered = { forEach: (fn)=> snap.forEach(ds => { const d=ds.data()||{}; if (d.month===month) fn(ds); }) };
        return aggregateTeacherDays(filtered);
      }
      function aggregateTeacherDays(snapLike){
        const perDay = {};
        snapLike.forEach(ds => {
          const raw = Array.isArray((ds.data()||{}).days) ? (ds.data().days) : [];
          const uniqueDays = [...new Set(raw.map(Number).filter(Number.isInteger))];
          uniqueDays.forEach(d => {
            const key=String(d);
            perDay[key]=(perDay[key]||0)+1;
          });
        });
        return perDay;
      }
    }

    // êµì‚¬ ë¯¸ì‹ ì²­ì ëª…ë‹¨
    async function getTeacherNoMealNames(year, month) {
      const qy  = query(mealRequestsCol, where("year","==",year), where("month","==",month));
      const snap = await getDocs(qy);
      const names = [];
      snap.forEach(ds => {
        const d = ds.data() || {};
        if (!Array.isArray(d.days) || d.days.length === 0) {
          const name = d.name || d.teacherName || d.displayName || d.email || ds.id || "êµì‚¬";
          names.push(name);
        }
      });
      return names;
    }

    // êµì‚¬ íŠ¹ì´ì‚¬í•­(ì¼ë¶€ ë‚ ì§œ ë¯¸ì‹ ì²­)
    async function listTeacherSpecialNotes(year, month, blocked) {
      const startDate = new Date(year, month - 1, 1);
      const endDate   = new Date(year, month, 0);
      const firstDayIndex = startDate.getDay();
      const lastDate  = endDate.getDate();
      const blockedSet = new Set(blocked);

      const schoolDays = [];
      for (let d=1; d<=lastDate; d++){
        const dow = (firstDayIndex + d - 1) % 7;
        const isWeekend = (dow===0 || dow===6);
        if (!isWeekend && !blockedSet.has(d)) schoolDays.push(d);
      }

      const qy  = query(mealRequestsCol, where("year","==",year), where("month","==",month));
      const snap = await getDocs(qy);

      const notes = [];
      snap.forEach(ds => {
        const d = ds.data() || {};
        const days = Array.isArray(d.days) ? [...new Set(d.days.map(Number).filter(Number.isInteger))] : [];
        if (days.length === 0) return;
        const name = d.name || d.teacherName || d.displayName || d.email || ds.id || "êµì‚¬";
        const daySet = new Set(days);
        const missing = schoolDays.filter(x => !daySet.has(x));
        if (missing.length > 0) {
          const maxShow = 10;
          const shownDays = missing.slice(0, maxShow).map(n => `${n}ì¼`).join(", ");
          const more  = missing.length > maxShow ? ` ì™¸ ${missing.length - maxShow}ì¼` : "";
          notes.push(`${name} ${shownDays}${more} ë¯¸ì‹ ì²­`);
        }
      });

      return notes;
    }

    async function computeAndSaveTotals(year, month) {
      const startDate = new Date(year, month - 1, 1);
      const endDate   = new Date(year, month, 0);
      const firstDayIndex = startDate.getDay();
      const lastDate  = endDate.getDate();

      const [studentDays, teacherDaysCount, blocked] = await Promise.all([
        fetchStudentDaysPreferEffective(year, month),
        countTeachersPerDay(year, month),
        fetchBlockedDays(year, month)
      ]);

      const daysMap = {};
      const strings = [];
      for (let d=1; d<=lastDate; d++){
        const dow = (firstDayIndex + d - 1) % 7;
        const isWeekend = (dow===0 || dow===6);
        if (isWeekend || blocked.includes(d)) continue;
        const total = (studentDays[String(d)]||0) + (teacherDaysCount[String(d)]||0);
        daysMap[String(d)] = total;
        strings.push(`${year}-${pad2(month)}-${pad2(d)} - ${total}ëª…`);
      }
      await setDoc(totalsRef(year, month), { days: daysMap, strings }, { merge:true });
      return { strings, blocked };
    }

    function renderList(year, month, strings) {
      title.textContent = `${year}ë…„ ${month}ì›” ê²°ê³¼`;
      totalList.innerHTML = "";
      if (!strings || strings.length===0) {
        totalList.innerHTML = `<div class="muted">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. [ì´ì› ê³„ì‚°/ì €ì¥]ì„ ëˆŒëŸ¬ ê³„ì‚°í•˜ì„¸ìš”.</div>`;
        return;
      }
      const frag = document.createDocumentFragment();
      strings.forEach(line=>{
        const [dateStr, countStr] = line.split(" - ");
        const row = document.createElement("div"); row.className="row";
        const date = document.createElement("div"); date.className="date"; date.textContent=dateStr;
        const count= document.createElement("div"); count.className="count"; count.textContent=countStr;
        row.append(date, count); frag.appendChild(row);
      });
      totalList.appendChild(frag);
    }

    async function renderSummary(year, month, blockedForNotes = null) {
      summaryTitle.textContent = `ìš”ì•½ - ${year}ë…„ ${pad2(month)}ì›”`;

      const noMealNames = await getTeacherNoMealNames(year, month);
      teacherNoMealNamesEl.textContent = noMealNames.length > 0 ? noMealNames.join(", ") : "ì—†ìŒ";

      const blocked = blockedForNotes ?? await fetchBlockedDays(year, month);
      const notes = await listTeacherSpecialNotes(year, month, blocked);
      teacherNotesWrap.innerHTML = (notes.length > 0)
        ? `<ul class="summary-list">${notes.map(t=>`<li>${t}</li>`).join("")}</ul>`
        : `<div class="muted">íŠ¹ì´ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

      const absSnap = await getDoc(studentAbsencesRef(year, month));
      const items = (absSnap.exists() && Array.isArray(absSnap.data().items)) ? absSnap.data().items : [];
      if (items.length > 0) {
        const liStudents = items.map(it => {
          const count = toInt(it?.count ?? 0);
          const situation = (it?.situation || it?.reason || "ì‚¬ìœ ");
          const fmt = (iso) => (!iso || iso.length < 10) ? "-" : `${iso.slice(5,7)}.${iso.slice(8,10)}`;
          const s = fmt(it?.start), e = fmt(it?.end);
          return `<li>${situation} ${count}ëª… ${s}${(s===e||e==='-') ? "" : `~${e}`}</li>`;
        }).join("");
        studentAdjustWrap.innerHTML = `<ul class="summary-list">${liStudents}</ul>`;
      } else {
        studentAdjustWrap.innerHTML = `<div class="muted">ë“±ë¡ëœ ë³€ë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
      }
    }

    // ìˆ˜ë™ ê³„ì‚° ë²„íŠ¼
    async function handleManualCalc() {
      const year  = parseInt(yearSelect.value,10);
      const month = parseInt(monthSelect.value,10);
      try {
        const { strings, blocked } = await computeAndSaveTotals(year, month);
        renderList(year, month, strings);
        await renderSummary(year, month, blocked);
        alert("ì´ì› ê³„ì‚° ë° ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch(e) {
        console.error(e);
        alert("ì´ì› ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (e?.message||e));
      }
    }

    // ìë™ ê³„ì‚°
    async function autoComputeAndRender() {
      const year  = parseInt(yearSelect.value,10);
      const month = parseInt(monthSelect.value,10);
      try {
        const { strings, blocked } = await computeAndSaveTotals(year, month);
        renderList(year, month, strings);
        await renderSummary(year, month, blocked);
      } catch (e) {
        console.error(e);
        totalList.innerHTML = `<div class="muted">ìë™ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>`;
        teacherNoMealNamesEl.textContent = "â€”";
        teacherNotesWrap.innerHTML = `<div class="muted">ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
        studentAdjustWrap.innerHTML = `<div class="muted">ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”© (ê¶Œí•œ í™•ì¸ í›„ ë“±ë¡)
    function wireEvents() {
      calcBtn.onclick = handleManualCalc;
      // í•„ìš”í•˜ë©´ ì•„ë˜ ì£¼ì„ í•´ì œí•´ì„œ ì—°/ì›” ë³€ê²½ ì‹œ ìë™ ê°±ì‹ 
      // yearSelect.addEventListener("change", autoComputeAndRender);
      // monthSelect.addEventListener("change", autoComputeAndRender);
    }

    // ğŸ”’ ê²Œì´íŠ¸: ë¡œê·¸ì¸ â†’ ë„ë©”ì¸(@sungil-i.kr) â†’ roles(admin)
    onAuthStateChanged(auth, async (user) => {
      if (!user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href = "index.html"; return; }
      const email = user.email || "";
      if (!/@sungil-i\.kr$/i.test(email)) {
        alert("êµë‚´ ê³„ì •(@sungil-i.kr)ìœ¼ë¡œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        await signOut(auth); location.href = "index.html"; return;
      }

      try {
        const role = await getDoc(doc(db, "roles", email));
        const isAdmin = role.exists() && role.data().role === "admin";
        if (!isAdmin) { alert("ê´€ë¦¬ì ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤."); location.href = "meal.html"; return; }
      } catch (e) {
        console.error("roles í™•ì¸ ì‹¤íŒ¨:", e);
        alert("ê¶Œí•œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return;
      }

      // âœ… ê¶Œí•œ OK â†’ ì´ì œë¶€í„° Firestore ì ‘ê·¼
      await autoComputeAndRender();
      wireEvents();
    });
  </script>
</body>
</html>
