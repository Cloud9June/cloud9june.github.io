<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ì¼ì •ë³´ê³  ì •ë³´ì²˜ë¦¬ì‚°ì—…ê¸°ì‚¬ ë­í‚¹ì „</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { --primary: #2563eb; --light: #eff6ff; --correct: #22c55e; --wrong: #ef4444; --text: #1f2937; }
        body { font-family: 'Pretendard', sans-serif; margin: 0; padding: 0; background-color: #f3f4f6; color: var(--text); display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 600px; background: white; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        .screen { display: none; flex-direction: column; height: 100%; }
        .active { display: flex; }

        /* ë¡œê·¸ì¸ UI */
        .login-bar { background: #1e293b; color: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .login-btn { background: #f59e0b; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .user-info { display: flex; align-items: center; gap: 8px; }
        .user-photo { width: 24px; height: 24px; border-radius: 50%; border: 1px solid white; }

        /* í—¤ë” & ë²„íŠ¼ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .home-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
        .timer-badge { background: #fee2e2; color: #991b1b; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 14px; display: none; }
        
        h1 { text-align: center; color: var(--primary); font-size: 24px; margin-bottom: 5px; margin-top: 10px; }
        .desc { text-align: center; color: #666; font-size: 14px; margin-bottom: 20px; }

        .mock-exam-btn { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3); width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .rank-btn { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 20px; width: 100%; }
        
        /* ë­í‚¹ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb; }
        .rank-item.top { background: #fffbeb; border-color: #fcd34d; }
        .rank-left { display: flex; align-items: center; gap: 10px; }
        .rank-badge { font-weight: bold; width: 24px; text-align: center; font-size: 16px; }
        .rank-name { font-weight: bold; font-size: 15px; }
        .rank-dept { font-size: 12px; color: #6b7280; margin-left: 5px; }
        .rank-right { text-align: right; }
        .rank-score { font-weight: bold; color: var(--primary); font-size: 16px; }
        .rank-time { font-size: 11px; color: #6b7280; }

        /* í€´ì¦ˆ UI */
        .question-box { font-size: 18px; font-weight: bold; margin-bottom: 20px; line-height: 1.5; }
        .option-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #d1d5db; border-radius: 8px; background: white; font-size: 16px; cursor: pointer; text-align: left; }
        .option-btn:hover { background: var(--light); border-color: var(--primary); }
        .input-box { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #d1d5db; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        .submit-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .next-btn { margin-top: 15px; width: 100%; padding: 15px; background: #374151; color: white; border: none; border-radius: 8px; cursor: pointer; display: none; }
        
        .feedback { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; display: none; }
        .feedback.correct { background: #dcfce7; color: #166534; }
        .feedback.wrong { background: #fee2e2; color: #991b1b; }

        /* ê³¼ëª© ë¦¬ìŠ¤íŠ¸ */
        .subject-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .subject-btn { flex: 1; padding: 15px; background: white; border: 1px solid #d1d5db; border-radius: 8px; text-align: left; font-weight: bold; cursor: pointer; }
        .subject-btn:hover { border-color: var(--primary); color: var(--primary); background: #f0fdf4; }
        .summary-btn { width: 60px; background: #fff7ed; border: 1px solid #fdba74; border-radius: 8px; color: #c2410c; font-weight: bold; font-size: 12px; text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }

        /* ì•Œë¦¼ ë°•ìŠ¤ */
        .notice-box { margin-top: 30px; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; font-size: 13px; color: #475569; line-height: 1.6; }
        .notice-box ul { margin: 0; padding-left: 20px; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-home" class="screen active">
        <div class="login-bar">
            <div class="user-info" id="user-display">
                <span>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
            </div>
            <button class="login-btn" id="auth-btn" onclick="handleAuth()">G ë¡œê·¸ì¸</button>
        </div>

        <h1>ì •ë³´ì²˜ë¦¬ì‚°ì—…ê¸°ì‚¬ ë­í‚¹ì „ ğŸ†</h1>
        <p class="desc">ì„±ì¼ì •ë³´ê³  ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” CBT ëŒ€ê²°</p>
        
        <button class="mock-exam-btn" onclick="startMockExam()">
            <span style="font-size: 24px;">â°</span>
            <span>ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ (ë­í‚¹ì „)</span>
        </button>
        <button class="rank-btn" onclick="showRanking()">ğŸ‘‘ ëª…ì˜ˆì˜ ì „ë‹¹ (ì‹¤ì‹œê°„ ë­í‚¹)</button>

        <div style="font-size: 14px; font-weight: bold; color: #4b5563; margin-bottom: 10px;">ëŠ¥ë ¥ë‹¨ìœ„ë³„ í•™ìŠµí•˜ê¸°</div>
        <div id="subject-list"></div>

        <div class="notice-box">
            <h3 style="margin:0 0 5px 0;">ğŸ“¢ ì•ˆë‚´ì‚¬í•­</h3>
            <ul>
                <li>ğŸ† <strong>ë­í‚¹ì „ ì°¸ì—¬ ë°©ë²•</strong>: í•™êµ ê³„ì •(@sungil-i.kr)ìœ¼ë¡œ ë¡œê·¸ì¸ í›„ 'ì‹¤ì „ ëª¨ì˜ê³ ì‚¬'ë¥¼ ì‘ì‹œí•˜ì„¸ìš”.</li>
                <li>ğŸ“š ì œê³µë˜ëŠ” [ìš”ì•½] ë‚´ìš©ì€ í•µì‹¬ ì‚¬í•­ ìœ„ì£¼ë¡œ ì •ë¦¬ëœ ê²ƒì…ë‹ˆë‹¤.</li>
                <li>ğŸ’¯ ê³ ë“ì ì„ ìœ„í•´ì„œëŠ” ë°˜ë“œì‹œ <strong>NCS í•™ìŠµëª¨ë“ˆ ì›ë¬¸</strong>ì„ í•¨ê»˜ ì°¸ê³ í•˜ì—¬ ê¹Šì´ ìˆê²Œ ê³µë¶€í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
                <li>ğŸ£ ì•„ì§ ì´ˆê¸° ë²„ì „ì´ì—ìš”! ì´ìš© ì¤‘ ë¬¸ì œë‚˜ ì˜¤íƒ€ë¥¼ ë°œê²¬í•˜ë©´ ì„ ìƒë‹˜ê»˜ ê¼­ ì•Œë ¤ì£¼ì„¸ìš”. ì—¬ëŸ¬ë¶„ì˜ ì œë³´ê°€ í° í˜ì´ ë©ë‹ˆë‹¤!</li>
            </ul>
        </div>
    </div>

    <div id="screen-quiz" class="screen">
        <div class="header">
            <button class="home-btn" onclick="confirmHome()">ğŸ </button>
            <div id="timer-badge" class="timer-badge"></div>
        </div>
        <div class="status-bar" style="margin-bottom:10px; color:#666; font-size:14px; display:flex; justify-content:space-between;">
            <span id="subject-title">ê³¼ëª©ëª…</span>
            <span id="progress-text"></span>
        </div>
        <div class="question-box" id="question-text"></div>
        <div id="options-area"></div>
        <div id="short-area" class="hidden">
            <input type="text" id="short-input" class="input-box" placeholder="ì •ë‹µ ì…ë ¥">
            <button class="submit-btn" onclick="checkShortAnswer()">ì œì¶œ</button>
        </div>
        <div id="feedback" class="feedback"></div>
        <button id="next-btn" class="next-btn" onclick="nextQuestion()">ë‹¤ìŒ</button>
    </div>

    <div id="screen-result" class="screen">
        <div id="capture-area" style="padding:20px; background:white; border-radius:10px;">
            <h1 style="margin-top:10px;">ì‹œí—˜ ì¢…ë£Œ!</h1>
            <p style="text-align: center; color: #666;" id="result-user-name"></p>
            
            <div style="text-align: center; font-size: 40px; font-weight: bold; color: var(--primary); margin: 20px 0;" id="final-score"></div>
            <p style="text-align: center; color: #666;" id="time-record"></p>
            
            <div style="text-align:center; margin-bottom:20px; font-weight:bold; color:#d97706;" id="rank-msg"></div>

            <table style="width:100%; border-collapse:collapse; font-size:13px; margin-top:20px;" id="analysis-table">
                <thead style="background:#f1f5f9;"><tr><th style="padding:8px; border:1px solid #e2e8f0;">ê³¼ëª©</th><th style="padding:8px; border:1px solid #e2e8f0;">ê²°ê³¼</th></tr></thead>
                <tbody id="analysis-body"></tbody>
            </table>
        </div>

        <button class="submit-btn" style="margin-top:10px; background:#4b5563;" onclick="captureResult()">ğŸ“¸ ê²°ê³¼ ì €ì¥</button>
        <button class="submit-btn" style="margin-top:10px;" onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
    </div>

    <div id="screen-rank" class="screen">
        <div class="header">
            <button class="home-btn" onclick="goHome()">â¬…ï¸</button>
            <h2 style="margin:0; font-size:20px; color:var(--primary);">ğŸ‘‘ ëª…ì˜ˆì˜ ì „ë‹¹</h2>
            <button onclick="resetRanking()" style="border:none; background:none; cursor:pointer; font-size: 20px">ğŸ—‘ï¸</button>
            
        </div>
        <div style="text-align: center; margin-bottom: 15px; font-size: 13px; color: #666;">
            * ì ìˆ˜ ë†’ì€ ìˆœ > ì‹œê°„ ë¹ ë¥¸ ìˆœ (ìµœëŒ€ 50ëª…)
        </div>
        <div id="leaderboard-list">
            <p style="text-align: center;">ë¡œë”© ì¤‘...</p>
        </div>
    </div>
</div>

<script src="quizData.js"></script>
<script>
    /* ============================================================
       âš ï¸ [ì„¤ì •] ì—¬ê¸°ì— Firebase ì„¤ì •ê°’ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”! 
       ============================================================ */

    const firebaseConfig = {
        apiKey: "AIzaSyAx4nzuxOpzVl5g1QFEWnJWAPmNEn0Uvg0",
        authDomain: "cbtranking.firebaseapp.com",
        projectId: "cbtranking",
        storageBucket: "cbtranking.firebasestorage.app",
        messagingSenderId: "545474705762",
        appId: "1:545474705762:web:28c04594254d5babd8143b",
    };

    // Firebase ì´ˆê¸°í™”
    let db = null;
    let auth = null;
    let currentUser = null;

    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        console.log("Firebase ì´ˆê¸°í™” ì„±ê³µ!"); // í™•ì¸ìš© ë¡œê·¸
    } catch (e) { 
        console.error("Firebase Init Error", e); 
        alert("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: " + e.message);
    }

    /* =========================================
       ì „ì—­ ë³€ìˆ˜
       ========================================= */
    let currentMode = "study"; 
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let mockScores = {};
    let timerInterval = null;
    let timeTakenSec = 0;
    const TIME_LIMIT_MIN = 20;

    // ìš”ì•½ì§‘ íŒŒì¼ ë§µí•‘
    const fileMap = {
        "1.ì‘ìš©SWê¸°ì´ˆê¸°ìˆ í™œìš©": "sub1.html", "2.ê°œë°œìí™˜ê²½êµ¬ì¶•": "sub2.html",
        "3.í”„ë¡œê·¸ë˜ë°ì–¸ì–´í™œìš©": "sub3.html", "4.í”„ë¡œê·¸ë˜ë°ì–¸ì–´ì‘ìš©": "sub4.html",
        "5.ì• í”Œë¦¬ì¼€ì´ì…˜í…ŒìŠ¤íŠ¸ìˆ˜í–‰": "sub5.html", "6.í™”ë©´êµ¬í˜„": "sub6.html",
        "7.ì• í”Œë¦¬ì¼€ì´ì…˜ë°°í¬": "sub7.html", "8.SQLí™œìš©": "sub8.html", "9.UIí…ŒìŠ¤íŠ¸": "sub9.html"
    };

    function init() {
        renderSubjectList();
        checkAuthState();
    }

    /* =========================================
       ğŸ” ì¸ì¦(Auth) ê´€ë ¨ ë¡œì§ (í•™êµ ê³„ì • ì²´í¬)
       ========================================= */
    function checkAuthState() {
        if(!auth) return;
        auth.onAuthStateChanged((user) => {
            const btn = document.getElementById('auth-btn');
            const display = document.getElementById('user-display');
            
            if (user) {
                // í•™êµ ê³„ì •ì¸ì§€ ì²´í¬
                if (!user.email.endsWith('@sungil-i.kr')) {
                    alert("ğŸš« í•™êµ ê³„ì •(@sungil-i.kr)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    auth.signOut();
                    return;
                }
                currentUser = user;
                btn.innerText = "ë¡œê·¸ì•„ì›ƒ";
                display.innerHTML = `
                    <img src="${user.photoURL}" class="user-photo">
                    <span>${user.displayName}ë‹˜</span>
                `;
            } else {
                currentUser = null;
                btn.innerText = "G ë¡œê·¸ì¸";
                display.innerHTML = `<span>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</span>`;
            }
        });
    }

    function handleAuth() {
        if(!auth) { alert("Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
        if (currentUser) {
            auth.signOut();
        } else {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
                console.error(error);
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
            });
        }
    }

    /* =========================================
       ë©”ì¸ ë¡œì§
       ========================================= */
    function renderSubjectList() {
        const list = document.getElementById('subject-list');
        list.innerHTML = "";
        if(typeof quizDatabase === 'undefined') return;

        Object.keys(quizDatabase).forEach(subject => {
            const row = document.createElement('div');
            row.className = 'subject-row';

            const quizBtn = document.createElement('button');
            quizBtn.className = 'subject-btn';
            quizBtn.innerText = subject;
            quizBtn.onclick = () => startStudyMode(subject);

            const studyBtn = document.createElement('a');
            studyBtn.href = fileMap[subject] || "#";
            studyBtn.target = "_blank";
            studyBtn.className = 'summary-btn';
            studyBtn.innerHTML = `<span>ğŸ“š</span><span>ì´ë¡ </span>`;

            row.appendChild(quizBtn);
            row.appendChild(studyBtn);
            list.appendChild(row);
        });
    }

    function startStudyMode(subject) {
        currentMode = "study";
        currentQuestions = [...quizDatabase[subject]];
        currentQuestions.forEach(q => q._subject = subject);
        resetQuiz();
        document.getElementById('subject-title').innerText = subject;
        switchScreen('screen-quiz');
        loadQuestion();
    }

    function startMockExam() {
        // [ì¤‘ìš”] ë­í‚¹ì „ì€ ë¡œê·¸ì¸ í•„ìˆ˜
        if (!currentUser) {
            alert("ğŸ”’ ë­í‚¹ì „ì€ í•™êµ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            handleAuth();
            return;
        }

        currentMode = "mock";
        currentQuestions = [];
        mockScores = {};
        
        Object.keys(quizDatabase).forEach(subj => {
            mockScores[subj] = 0;
            const pool = [...quizDatabase[subj]].sort(() => Math.random() - 0.5);
            const selected = pool.slice(0, 5);
            selected.forEach(q => q._subject = subj);
            currentQuestions.push(...selected);
        });

        if(currentQuestions.length === 0) { alert("ë¬¸ì œ ë°ì´í„° ì—†ìŒ"); return; }

        resetQuiz();
        document.getElementById('subject-title').innerText = "ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ (ë­í‚¹ì „)";
        document.getElementById('timer-badge').style.display = 'block';
        startTimer(TIME_LIMIT_MIN * 60);
        switchScreen('screen-quiz');
        loadQuestion();
    }

    function resetQuiz() {
        currentIndex = 0; score = 0; timeTakenSec = 0; isAnswered = false;
        document.getElementById('timer-badge').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('feedback').style.display = 'none';
    }

    function startTimer(duration) {
        let timer = duration;
        updateTimerUI(timer);
        timerInterval = setInterval(() => {
            timer--; timeTakenSec++;
            updateTimerUI(timer);
            if (timer <= 0) { stopTimer(); alert("ì‹œê°„ ì¢…ë£Œ!"); showResult(); }
        }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }
    function updateTimerUI(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        document.getElementById('timer-badge').innerText = `ë‚¨ì€ ì‹œê°„ ${m}:${s < 10 ? '0'+s : s}`;
    }

    function loadQuestion() {
        isAnswered = false;
        const qData = currentQuestions[currentIndex];
        document.getElementById('progress-text').innerText = `${currentIndex+1} / ${currentQuestions.length}`;
        document.getElementById('question-text').innerText = `Q. ${qData.q}`;
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        
        const optsArea = document.getElementById('options-area');
        const shortArea = document.getElementById('short-area');
        optsArea.innerHTML = ""; document.getElementById('short-input').value = "";

        if(qData.type === 'choice') {
            shortArea.classList.add('hidden'); optsArea.classList.remove('hidden');
            qData.o.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, qData);
                optsArea.appendChild(btn);
            });
        } else {
            optsArea.classList.add('hidden'); shortArea.classList.remove('hidden');
        }
    }

    function checkAnswer(userVal, qData) {
        if(isAnswered) return;
        isAnswered = true;
        const feedback = document.getElementById('feedback');
        feedback.style.display = 'block';
        
        if(userVal === qData.a) {
            score++;
            if(currentMode === 'mock') mockScores[qData._subject]++;
            feedback.innerText = "ì •ë‹µì…ë‹ˆë‹¤! â­•";
            feedback.className = "feedback correct";
        } else {
            feedback.innerHTML = `ì˜¤ë‹µì…ë‹ˆë‹¤ âŒ<br>ì •ë‹µ: ${qData.a}`;
            feedback.className = "feedback wrong";
        }
        document.getElementById('next-btn').style.display = 'block';
    }

    function checkShortAnswer() {
        if(isAnswered) return;
        const input = document.getElementById('short-input');
        const userVal = input.value.trim().replace(/\s+/g, '').toLowerCase();
        if(!userVal) { alert("ë‹µì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
        
        const qData = currentQuestions[currentIndex];
        const correctVal = qData.a.trim().replace(/\s+/g, '').toLowerCase();
        
        isAnswered = true;
        const feedback = document.getElementById('feedback');
        feedback.style.display = 'block';

        if(userVal === correctVal) {
            score++;
            if(currentMode === 'mock') mockScores[qData._subject]++;
            feedback.innerText = "ì •ë‹µì…ë‹ˆë‹¤! â­•";
            feedback.className = "feedback correct";
        } else {
            feedback.innerHTML = `ì˜¤ë‹µì…ë‹ˆë‹¤ âŒ<br>ì •ë‹µ: ${qData.a}`;
            feedback.className = "feedback wrong";
        }
        document.getElementById('next-btn').style.display = 'block';
    }

    function nextQuestion() {
        currentIndex++;
        if(currentIndex < currentQuestions.length) loadQuestion();
        else { stopTimer(); showResult(); }
    }

    function showResult() {
        switchScreen('screen-result');
        document.getElementById('final-score').innerText = `${score}ì  / ${currentQuestions.length}`;
        const min = Math.floor(timeTakenSec / 60);
        const sec = timeTakenSec % 60;
        document.getElementById('time-record').innerText = `â± ì†Œìš” ì‹œê°„: ${min}ë¶„ ${sec}ì´ˆ`;
        document.getElementById('result-user-name').innerText = currentUser ? `${currentUser.displayName}ë‹˜ì˜ ê²°ê³¼` : "ê²°ê³¼";

        const tbody = document.getElementById('analysis-body');
        tbody.innerHTML = "";
        
        if (currentMode === "mock") {
            // DBì— ë­í‚¹ ìë™ ì €ì¥
            saveRankToDB();

            document.getElementById('analysis-table').style.display = 'table';
            Object.keys(mockScores).forEach(subj => {
                const count = mockScores[subj];
                const tr = document.createElement('tr');
                const subjName = subj.replace(/^\d+\./, '');
                let stat = `${count} / 5`;
                if(count <= 2) stat += ` <span style="color:red; font-weight:bold;">(ë³´ì¶© í•„ìš”)</span>`;
                tr.innerHTML = `<td>${subjName}</td><td style="text-align:center;">${stat}</td>`;
                tbody.appendChild(tr);
            });
        } else {
            document.getElementById('analysis-table').style.display = 'none';
            document.getElementById('rank-msg').innerText = "ë‹¨ì›ë³„ í•™ìŠµ ì™„ë£Œ!";
        }
    }

    function saveRankToDB() {
        if(!db || !currentUser) return;
        
        // Firestoreì— ì €ì¥ (ì»¬ë ‰ì…˜: leaderboard)
        db.collection("leaderboard").add({
            name: currentUser.displayName,
            email: currentUser.email,
            score: score,
            time: timeTakenSec,
            date: new Date().toISOString()
        }).then(() => {
            document.getElementById('rank-msg').innerText = "ğŸ† ë­í‚¹ì— ì ìˆ˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!";
        }).catch(err => {
            console.error("Rank Save Error", err);
            document.getElementById('rank-msg').innerText = "ë­í‚¹ ë“±ë¡ ì‹¤íŒ¨ (ì¸í„°ë„· í™•ì¸)";
        });
    }

    function showRanking() {
        switchScreen('screen-rank');
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = "ë¡œë”© ì¤‘...";

        if(!db) { list.innerHTML = "<p>DB ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>"; return; }

        // 1ìˆœìœ„: ì ìˆ˜(ë‚´ë¦¼ì°¨ìˆœ), 2ìˆœìœ„: ì‹œê°„(ì˜¤ë¦„ì°¨ìˆœ)
        db.collection("leaderboard")
            .orderBy("score", "desc")
            .orderBy("time", "asc")
            .limit(50)
            .get()
            .then(snapshot => {
                list.innerHTML = "";
                let rank = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const min = Math.floor(data.time / 60);
                    const sec = data.time % 60;
                    
                    const item = document.createElement('div');
                    item.className = `rank-item ${rank <= 3 ? 'top' : ''}`;
                    item.innerHTML = `
                        <div class="rank-left">
                            <div class="rank-badge">${rank <= 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][rank-1] : rank}</div>
                            <div>
                                <div class="rank-name">${data.name}</div>
                                <div class="rank-dept">ì„±ì¼ì •ë³´ê³ </div>
                            </div>
                        </div>
                        <div class="rank-right">
                            <div class="rank-score">${data.score}ì </div>
                            <div class="rank-time">${min}ë¶„ ${sec}ì´ˆ</div>
                        </div>
                    `;
                    list.appendChild(item);
                    rank++;
                });
                if(rank === 1) list.innerHTML = "<p>ì•„ì§ ë“±ë¡ëœ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            })
            .catch(error => {
                console.error("Ranking Load Error", error);
                list.innerHTML = `<p>ë­í‚¹ ë¡œë”© ì‹¤íŒ¨<br><a href="#" onclick="alert('ìƒ‰ì¸(Index) ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ê´€ë¦¬ì ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.')">ì˜¤ë¥˜ ìƒì„¸</a></p>`;
            });
    }

    /* =========================================
   [ì¶”ê°€] ë­í‚¹ ì´ˆê¸°í™” ê¸°ëŠ¥ (ê´€ë¦¬ììš©)
   ========================================= */
    async function resetRanking() {
        // 1. ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        const password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n(ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤!)");
        
        // ì„ ìƒë‹˜ì´ ì›í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¡œ ë°”ê¾¸ì„¸ìš” (ì˜ˆ: "sungil1234")
        if (password !== "sungil1234!") { 
            if(password !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            return; 
        }

        if (!confirm("ì •ë§ ëª¨ë“  ë­í‚¹ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        // 2. ë°ì´í„° ì‚­ì œ ë¡œì§ (Batch ì‚­ì œ)
        try {
            const collectionRef = db.collection("leaderboard");
            const snapshot = await collectionRef.get();

            if (snapshot.empty) {
                alert("ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // FirestoreëŠ” í•œ ë²ˆì— 500ê°œê¹Œì§€ë§Œ ì¼ê´„ ì‚­ì œ ê°€ëŠ¥ (ë°°ì¹˜ ì²˜ë¦¬)
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });

            await batch.commit(); // ì‹¤í–‰
            alert("ğŸ—‘ï¸ ë­í‚¹ì´ ê¹”ë”í•˜ê²Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
            showRanking(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨

        } catch (error) {
            console.error("Reset Error", error);
            alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + error.message);
        }
    }

    function goHome() { switchScreen('screen-home'); }
    function confirmHome() { if(confirm("ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { stopTimer(); goHome(); } }
    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function captureResult() {
        html2canvas(document.getElementById('capture-area')).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ì„±ì¼ì •ë³´ê³ _ë­í‚¹ì „_ê²°ê³¼.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    init();
</script>
</body>
</html>